---
phase: 02.1-dashboard-card-component
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/plugins/interactive-dashboard/components/DashboardCard.vue
autonomous: true

must_haves:
  truths:
    - "DashboardCard manages fullscreen CSS state when isFullscreen prop is true"
    - "DashboardCard dispatches window resize event when exiting fullscreen"
    - "DashboardCard watches for size changes via ResizeObserver"
    - "DashboardCard emits cardResize event with dimensions when container size changes"
  artifacts:
    - path: "src/plugins/interactive-dashboard/components/DashboardCard.vue"
      provides: "Fullscreen styling and resize event propagation"
      contains: "ResizeObserver"
  key_links:
    - from: "DashboardCard.vue"
      to: "window.dispatchEvent"
      via: "resize event on fullscreen exit"
      pattern: "dispatchEvent.*resize"
---

<objective>
Add fullscreen state management and resize event propagation to DashboardCard.

Purpose: Ensure cards correctly apply fullscreen styling and notify children when they need to resize. This fixes the scatter plot overflow bug and missing button issues discovered in Phase 2.

Output: Enhanced DashboardCard.vue with fullscreen and resize capabilities.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan SUMMARY (DashboardCard foundation)
# NOTE: This plan runs in parallel with 02.1-01, so DashboardCard.vue may not exist yet.
# If it doesn't exist, create it with fullscreen/resize features included from the start.

# Current fullscreen logic to port
@src/plugins/interactive-dashboard/InteractiveDashboard.vue (lines 841-868 for toggleZoom, 871-919 for getCardStyle)

# ScatterCard resize handling (pattern to support)
@src/plugins/interactive-dashboard/components/cards/ScatterCard.vue (lines 422-453 for resize observer)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add fullscreen styling to DashboardCard</name>
  <files>src/plugins/interactive-dashboard/components/DashboardCard.vue</files>
  <action>
Enhance the cardStyle computed property to properly handle fullscreen state.

**Fullscreen cardStyle logic:**
When isFullscreen is true:
```typescript
return {
  position: 'fixed',
  top: '0',
  left: '0',
  right: '0',
  bottom: '0',
  zIndex: '10000',  // Higher than DataTableCard's 9999
  margin: '0',
  padding: '1rem',
  backgroundColor: 'var(--bgBold)',
}
```

When another card is fullscreen (parent passes fullscreenCardId, and this card is NOT it):
```typescript
return { display: 'none' }
```

**Add prop:**
```typescript
fullscreenCardId: { type: String, default: '' }
```

**Update cardStyle computed:**
```typescript
const cardStyle = computed(() => {
  // If another card is fullscreen, hide this one
  if (props.fullscreenCardId && props.fullscreenCardId !== props.card.id) {
    return { display: 'none' }
  }

  // If this card is fullscreen, apply fullscreen styles
  if (props.isFullscreen) {
    return {
      position: 'fixed',
      top: '0',
      left: '0',
      right: '0',
      bottom: '0',
      zIndex: '10000',
      margin: '0',
      padding: '1rem',
      backgroundColor: 'var(--bgBold)',
    }
  }

  // Normal card styling
  const defaultHeight = props.card.type === 'text' ? undefined : 300
  const height = props.card.height ? props.card.height * 60 : defaultHeight
  const flex = props.card.width || 1

  const style: Record<string, any> = { flex }

  if (props.card.backgroundColor || props.card.background) {
    style.backgroundColor = props.card.backgroundColor || props.card.background
  }

  if (height && !props.isFullScreenDashboard) {
    style.minHeight = `${height}px`
    style.maxHeight = `${height}px`
    style.height = `${height}px`
  }

  return style
})
```

**Update interface in types/dashboardCard.ts:**
Add fullscreenCardId to DashboardCardProps interface.
  </action>
  <verify>Card hides when fullscreenCardId is set to another card's ID. Card shows fullscreen styling when isFullscreen=true.</verify>
  <done>DashboardCard applies correct CSS for fullscreen and hidden states</done>
</task>

<task type="auto">
  <name>Task 2: Add resize event propagation</name>
  <files>src/plugins/interactive-dashboard/components/DashboardCard.vue</files>
  <action>
Add ResizeObserver to detect container size changes and emit resize events.

**Setup resize observer:**
```typescript
import { ref, onMounted, onUnmounted, watch, nextTick } from 'vue'

const contentWrapper = ref<HTMLElement | null>(null)
let resizeObserver: ResizeObserver | null = null

const emit = defineEmits<{
  'toggle-fullscreen': [cardId: string]
  'toggle-info': [cardId: string]
  'clear-errors': [cardId: string]
  'card-resize': [cardId: string, dimensions: { width: number; height: number }]
}>()

function emitResize() {
  if (!contentWrapper.value) return
  const { clientWidth, clientHeight } = contentWrapper.value
  emit('card-resize', props.card.id, { width: clientWidth, height: clientHeight })
}

onMounted(() => {
  if (contentWrapper.value) {
    resizeObserver = new ResizeObserver(() => {
      // Debounce slightly to avoid excessive updates
      nextTick(() => emitResize())
    })
    resizeObserver.observe(contentWrapper.value)
  }
})

onUnmounted(() => {
  if (resizeObserver) {
    resizeObserver.disconnect()
    resizeObserver = null
  }
})
```

**Add ref to template:**
```pug
.card-content-wrapper(ref="contentWrapper" :id="card.id" :class="{'is-loaded': card.isLoaded}")
  slot
```

**Watch for fullscreen changes:**
When exiting fullscreen, dispatch window resize event so ALL charts resize:
```typescript
watch(() => props.isFullscreen, (isNowFullscreen, wasFullscreen) => {
  if (wasFullscreen && !isNowFullscreen) {
    // Exiting fullscreen - trigger global resize
    nextTick(() => {
      window.dispatchEvent(new Event('resize'))
      emitResize()  // Also emit specific card resize
    })
  } else if (isNowFullscreen) {
    // Entering fullscreen - also need resize
    nextTick(() => emitResize())
  }
})
```

This ensures:
1. Plotly charts (ScatterCard, HistogramCard) receive window resize events
2. Content components can listen to card-resize for more specific handling
3. Both fullscreen entry and exit trigger resize
  </action>
  <verify>
1. Console log shows card-resize events when browser window is resized
2. Exiting fullscreen dispatches window resize event
  </verify>
  <done>DashboardCard observes container size and emits card-resize events; dispatches window resize on fullscreen exit</done>
</task>

<task type="auto">
  <name>Task 3: Add Escape key handler for fullscreen exit</name>
  <files>src/plugins/interactive-dashboard/components/DashboardCard.vue</files>
  <action>
Add keyboard event listener to handle Escape key for fullscreen exit.

**Add keydown listener:**
```typescript
function handleKeydown(event: KeyboardEvent) {
  if (event.key === 'Escape' && props.isFullscreen) {
    emit('toggle-fullscreen', props.card.id)
  }
}

onMounted(() => {
  // Only add listener if this component could be fullscreen
  window.addEventListener('keydown', handleKeydown)
  // ... rest of onMounted
})

onUnmounted(() => {
  window.removeEventListener('keydown', handleKeydown)
  // ... rest of onUnmounted
})
```

**Guard against multiple handlers:**
Only the fullscreen card should respond to Escape. The condition `props.isFullscreen` in the handler ensures only the currently fullscreen card triggers the exit.

**Per STATE.md lesson:** "Dual Escape key handling - Both portal and dashboard handle Escape for redundancy"

This provides redundant Escape handling at the card level, complementing any dashboard-level handler.
  </action>
  <verify>Press Escape while a card is fullscreen - it should emit toggle-fullscreen event</verify>
  <done>Escape key exits fullscreen by emitting toggle-fullscreen event</done>
</task>

</tasks>

<verification>
1. Build succeeds: `npm run build`
2. TypeScript compiles: `npx tsc --noEmit`
3. Manual test: Card with isFullscreen=true covers viewport with z-index 10000
4. Manual test: Other cards hidden when fullscreenCardId is set
5. Manual test: Escape key emits toggle-fullscreen event
6. Manual test: Window resize event fired when exiting fullscreen
</verification>

<success_criteria>
- DashboardCard correctly applies fullscreen positioning (fixed, top/left/right/bottom 0)
- DashboardCard hides other cards when one is fullscreen (display: none)
- DashboardCard dispatches window resize event on fullscreen exit
- DashboardCard emits card-resize event when container dimensions change
- Escape key triggers fullscreen exit
- ResizeObserver properly cleaned up on unmount
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-dashboard-card-component/02.1-02-SUMMARY.md`
</output>
