---
phase: 01.1-adaptive-layer-coloring
plan: 02
type: execute
wave: 2
depends_on: ["01.1-01"]
files_modified:
  - src/plugins/interactive-dashboard/components/cards/MapCard.vue
  - src/plugins/interactive-dashboard/InteractiveDashboard.vue
autonomous: true
user_setup: []

must_haves:
  truths:
    - "MapCard uses layer roles to determine colorBy application"
    - "Neutral layers render with subtle boundary colors"
    - "InteractiveDashboard passes layerStrategy from YAML"
    - "colorBy selector only colors primary layers"
  artifacts:
    - path: "src/plugins/interactive-dashboard/components/cards/MapCard.vue"
      provides: "Role-aware color computation"
      contains: "computeAllLayerRoles"
    - path: "src/plugins/interactive-dashboard/InteractiveDashboard.vue"
      provides: "YAML config parsing for layerStrategy"
      contains: "layerStrategy"
  key_links:
    - from: "InteractiveDashboard.vue"
      to: "MapCard.vue"
      via: "layerStrategy prop"
      pattern: "layerStrategy"
    - from: "MapCard.vue"
      to: "LayerColoringManager"
      via: "import and call"
      pattern: "computeAllLayerRoles"
---

<objective>
Integrate LayerColoringManager into MapCard and InteractiveDashboard to enable automatic adaptive coloring based on visible layer relationships.

Purpose: When users switch between viewing single geometry (origin clusters), multiple geometries, or OD views (origin + destination + arcs), the coloring automatically adapts to show the most relevant data layer.

Output: Working adaptive coloring system where arcs get colorBy when visible with clusters, and clusters get colorBy when viewed alone.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01.1-adaptive-layer-coloring/01.1-RESEARCH.md
@.planning/phases/01.1-adaptive-layer-coloring/01.1-01-SUMMARY.md

# Code to modify
@src/plugins/interactive-dashboard/components/cards/MapCard.vue
@src/plugins/interactive-dashboard/InteractiveDashboard.vue

# Manager to integrate
@src/plugins/interactive-dashboard/managers/LayerColoringManager.ts
@src/plugins/interactive-dashboard/types/layerColoring.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add layerStrategy prop and YAML parsing to InteractiveDashboard</name>
  <files>src/plugins/interactive-dashboard/InteractiveDashboard.vue</files>
  <action>
Modify InteractiveDashboard.vue to:

1. **Parse YAML configuration for layerStrategy:**
   - Read `yaml.map?.colorBy?.layerStrategy` (default: 'auto')
   - Store in component data: `layerStrategy: 'auto' | 'explicit' | 'all'`

2. **Pass layerStrategy to MapCard:**
   - Add `:layer-strategy="layerStrategy"` to MapCard component binding
   - In `getCardLayers()` method, do NOT apply colorBy to layers - let MapCard handle it based on roles

3. **Modify getCardLayers() to stop applying colorBy:**
   - Currently lines ~588-603 apply colorBy to layers without static color
   - REMOVE this logic - the colorBy application should happen in MapCard based on computed roles
   - getCardLayers should only filter by geometryType, not modify layer configs

This ensures MapCard receives unmodified layer configs and can apply role-based coloring.
  </action>
  <verify>TypeScript compiles: `cd /mnt/Shared/Code/projects/Dissertation/simwrapper && npx tsc --noEmit 2>&1 | head -20`</verify>
  <done>InteractiveDashboard parses layerStrategy from YAML and passes to MapCard, getCardLayers no longer applies colorBy</done>
</task>

<task type="auto">
  <name>Task 2: Integrate LayerColoringManager into MapCard</name>
  <files>src/plugins/interactive-dashboard/components/cards/MapCard.vue</files>
  <action>
Modify MapCard.vue to use LayerColoringManager for adaptive coloring:

1. **Add new prop:**
   ```typescript
   layerStrategy: {
     type: String as PropType<'auto' | 'explicit' | 'all'>,
     default: 'auto'
   }
   ```

2. **Import and use LayerColoringManager:**
   ```typescript
   import { computeAllLayerRoles } from '@/plugins/interactive-dashboard/managers/LayerColoringManager'
   import type { LayerColoringRole } from '@/plugins/interactive-dashboard/types/layerColoring'
   ```

3. **Add reactive ref for computed roles:**
   ```typescript
   const layerRoles = ref<Map<string, LayerColoringRole>>(new Map())
   ```

4. **Compute roles in updateLayers():**
   At the start of updateLayers(), before creating deck.gl layers:
   ```typescript
   layerRoles.value = computeAllLayerRoles(props.layers, props.layerStrategy)
   ```

5. **Modify getBaseColor() to respect roles:**
   At the BEGINNING of getBaseColor(), add:
   ```typescript
   // Check layer role - neutral layers skip colorBy
   const role = layerRoles.value.get(layerConfig.name)
   if (role?.role === 'neutral') {
     // Return neutral theme color - subtle boundary without data coloring
     const styleManager = StyleManager.getInstance()
     return hexToRgb(styleManager.getColor('theme.border.default'))
   }

   // Primary/secondary layers continue with existing color priority logic
   ```
   This ensures neutral layers always get subtle styling regardless of colorBy selection.

6. **Add layerRoles to updateTriggers:**
   In the deck.gl layer configurations, add `layerRoles.value` to updateTriggers for getFillColor/getLineColor:
   ```typescript
   updateTriggers: {
     getFillColor: [
       props.colorByAttribute,
       props.hoveredIds,
       props.selectedIds,
       layerRoles.value,  // Add this
       // ... existing triggers
     ]
   }
   ```

Note: Do NOT change getFillColor/getLineColor accessor functions directly - they already call getBaseColor which we modified. The updateTrigger ensures re-render when roles change.
  </action>
  <verify>TypeScript compiles and dev server runs: `cd /mnt/Shared/Code/projects/Dissertation/simwrapper && npm run dev &amp;&amp; sleep 5 &amp;&amp; curl -s http://localhost:8080 | head -5`</verify>
  <done>MapCard computes layer roles on each render and uses them in getBaseColor to apply neutral styling to non-primary layers</done>
</task>

<task type="auto">
  <name>Task 3: Add colorByRole per-layer override support</name>
  <files>src/plugins/interactive-dashboard/components/cards/MapCard.vue</files>
  <action>
Extend MapCard to support per-layer colorByRole overrides from YAML:

1. **Update LayerConfig interface** (or verify it's already there):
   The LayerConfig type should already accept `colorByRole?: 'primary' | 'secondary' | 'neutral' | 'auto'`
   - Check the existing interface in MapCard.vue (around line 100-130)
   - Add `colorByRole?: ColorByRole` if not present

2. **Verify computeLayerRole handles override:**
   The LayerColoringManager from Plan 01 already checks `layer.colorByRole` first.
   No code changes needed if implemented correctly.

3. **Test that override works:**
   When a layer has `colorByRole: neutral` in YAML, it should always render with neutral styling even when it would auto-detect as primary.

This task is primarily verification - the override logic should already be in LayerColoringManager.
  </action>
  <verify>No TypeScript errors in LayerConfig with colorByRole field: `cd /mnt/Shared/Code/projects/Dissertation/simwrapper && npx tsc --noEmit 2>&1 | grep -i colorByRole || echo "No colorByRole errors"`</verify>
  <done>colorByRole field accepted in LayerConfig, override behavior verified in LayerColoringManager</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. Dev server starts: `npm run dev`
3. Test scenario (manual):
   - Configure dashboard with origin clusters + destination clusters + arcs
   - Select "Origin" geometry type -> origin clusters should be colored by attribute
   - Select "OD" geometry type -> arcs should be colored, clusters should be neutral (gray boundaries)
   - Select colorBy attribute -> only primary layer(s) change color
</verification>

<success_criteria>
- InteractiveDashboard passes layerStrategy prop to MapCard
- MapCard computes layer roles using LayerColoringManager
- getBaseColor returns neutral theme color for neutral layers
- updateTriggers include layerRoles for re-render on visibility change
- Per-layer colorByRole override works
- TypeScript compilation succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/01.1-adaptive-layer-coloring/01.1-02-SUMMARY.md`
</output>
