---
phase: 01.1-adaptive-layer-coloring
plan: 03
type: execute
wave: 3
depends_on: ["01.1-02"]
files_modified:
  - src/plugins/interactive-dashboard/components/cards/MapCard.vue
  - src/plugins/interactive-dashboard/managers/LayerColoringManager.ts
autonomous: false
user_setup: []

must_haves:
  truths:
    - "User views origin clusters only and sees them colored by attribute"
    - "User views destination clusters only and sees them colored by attribute"
    - "User switches to OD view and arcs become colored while clusters become neutral"
    - "Neutral clusters still show hover/select highlights"
    - "Layer transitions are smooth without visual glitches"
  artifacts:
    - path: "src/plugins/interactive-dashboard/components/cards/MapCard.vue"
      provides: "Polished adaptive coloring with edge cases handled"
      contains: "neutral"
    - path: "src/plugins/interactive-dashboard/managers/LayerColoringManager.ts"
      provides: "Robust grouping with edge case handling"
      contains: "toLowerCase"
  key_links:
    - from: "MapCard.vue neutral colors"
      to: "StyleManager theme.border.default"
      via: "getColor call"
      pattern: "theme\\.border\\.default"
---

<objective>
Verify adaptive layer coloring works correctly across all visibility scenarios and polish edge cases.

Purpose: Ensure the implementation handles real-world scenarios correctly - case-insensitive geoProperty matching, proper hover/select on neutral layers, and smooth transitions between geometry types.

Output: Production-ready adaptive coloring that meets all success criteria from the phase requirements.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01.1-adaptive-layer-coloring/01.1-RESEARCH.md
@.planning/phases/01.1-adaptive-layer-coloring/01.1-01-SUMMARY.md
@.planning/phases/01.1-adaptive-layer-coloring/01.1-02-SUMMARY.md

# Code to verify/polish
@src/plugins/interactive-dashboard/components/cards/MapCard.vue
@src/plugins/interactive-dashboard/managers/LayerColoringManager.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Ensure neutral layers maintain hover/select highlighting</name>
  <files>src/plugins/interactive-dashboard/components/cards/MapCard.vue</files>
  <action>
Verify and fix that neutral layers still show interaction states:

1. **Check getPolygonFillColor / getLineColor functions:**
   These functions check `isHovered` and `isSelected` BEFORE calling getBaseColor.
   Ensure the hover/select color application happens REGARDLESS of layer role.

   The current flow should be:
   ```
   if (isHovered) return hoverColor
   if (isSelected) return selectedColor
   return getBaseColor(...)  // This is where neutral check happens
   ```

   If the order is different, fix it so hover/select always takes precedence.

2. **Test neutral layer interaction:**
   A neutral cluster should still:
   - Turn orange (#fbbf24) on hover
   - Turn blue (#3b82f6) on selection
   - Return to neutral gray when not interacted with

3. **Verify alpha handling for neutral layers:**
   Neutral layers should use full opacity for boundaries (not dimmed).
   Check that the neutral color from StyleManager uses appropriate alpha.
  </action>
  <verify>Hover/select interaction code precedes getBaseColor call in fill/line color functions</verify>
  <done>Neutral layers show hover=orange and selected=blue highlighting, returning to neutral gray when not interacted</done>
</task>

<task type="auto">
  <name>Task 2: Add debug logging for layer role computation</name>
  <files>src/plugins/interactive-dashboard/managers/LayerColoringManager.ts</files>
  <action>
Add optional debug logging to help diagnose coloring behavior:

1. **Add debug flag:**
   ```typescript
   const DEBUG_LAYER_COLORING = false // Set true for development debugging
   ```

2. **Add logging in computeAllLayerRoles:**
   ```typescript
   if (DEBUG_LAYER_COLORING) {
     console.log('[LayerColoring] Computing roles for', layers.length, 'layers')
     console.log('[LayerColoring] Strategy:', strategy)
     groups.forEach((group, key) => {
       console.log(`[LayerColoring] Group "${key}": ${group.layers.length} layers, hasArc=${group.hasArc}, geometryCount=${group.geometryCount}`)
     })
     roles.forEach((role, layerName) => {
       console.log(`[LayerColoring] Layer "${layerName}": role=${role.role}, reason=${role.reason}`)
     })
   }
   ```

This helps users and developers understand why layers get certain roles.
  </action>
  <verify>Debug logging exists but is disabled by default</verify>
  <done>DEBUG_LAYER_COLORING flag added with console.log statements for group and role computation</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Adaptive layer coloring system with intelligent role detection</what-built>
  <how-to-verify>
1. Start dev server: `npm run dev`
2. Open a dashboard with origin clusters, destination clusters, and arcs (all with same linkage.geoProperty)
3. Select "Origin" geometry type:
   - Verify: Origin clusters are colored by the selected colorBy attribute
   - Verify: Destination clusters and arcs are NOT visible
4. Select "Destination" geometry type:
   - Verify: Destination clusters are colored by attribute
   - Verify: Origin clusters and arcs are NOT visible
5. Select "OD" or "All" geometry type (showing all layers):
   - Verify: ARCS are colored by the selected attribute
   - Verify: Origin AND destination clusters are NEUTRAL (subtle gray boundaries)
6. With OD view active, hover over a neutral cluster:
   - Verify: Cluster turns orange (hover color)
7. Click on a neutral cluster:
   - Verify: Cluster turns blue (selected color)
8. Change the colorBy attribute selector:
   - Verify: Only arcs change color, clusters remain neutral

If any verification fails, describe the issue.
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. All tests pass: `npm run test:run`
2. TypeScript compiles: `npx tsc --noEmit`
3. Visual verification of all success criteria from phase requirements
4. Debug logging can be enabled without code changes (just flip flag)
</verification>

<success_criteria>
From phase requirements:
1. User views origin clusters only -> clusters colored by attribute [VERIFIED]
2. User views destination clusters only -> clusters colored by attribute [VERIFIED]
3. User switches to OD view -> arcs colored, clusters neutral [VERIFIED]
4. User configures layerStrategy: explicit -> only colorByRole: primary layers colored [VERIFIED]
5. Developer can override with colorByRole per-layer [VERIFIED]

Additional:
- Neutral layers show hover/select interaction states
- Debug logging available for troubleshooting
- No visual glitches during geometry type transitions
</success_criteria>

<output>
After completion, create `.planning/phases/01.1-adaptive-layer-coloring/01.1-03-SUMMARY.md`
</output>
