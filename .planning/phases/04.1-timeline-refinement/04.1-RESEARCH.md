# Phase 4.1: Timeline Refinement - Research

**Researched:** 2026-01-22
**Domain:** Plotly.js zoom events, Vue 2 modal patterns, TimelineCard refactoring
**Confidence:** HIGH

## Summary

This phase refines the existing TimelineCard implementation (~1240 lines) to simplify UX by adding mouse wheel zoom centered on cursor position, a degree filter control with multi-select checkboxes, and replacing the inline expandable detail view with a modal. The existing codebase provides solid patterns for all requirements.

**Key findings:**
1. Plotly.js built-in `scrollZoom: true` enables wheel zoom but does NOT center on cursor by default - requires custom wheel event handler with `Plotly.relayout()` to implement cursor-centered zoom
2. Vue 2 lacks Teleport (Vue 3 only), but SimWrapper already has working modal patterns using CSS positioning (`position: absolute/fixed`) without portal libraries
3. Selection behavior refactor from multi-select to single-select is straightforward - change from `Set.add()` toggle logic to simple replacement
4. Existing ComparisonToggle.vue provides the pattern for checkbox-based controls
5. Minimap area already exists with room to relocate zoom buttons

**Primary recommendation:** Implement custom wheel event handler for cursor-centered zoom; create DegreeFilterControl.vue as reusable control; create RideDetailModal.vue using existing SaveMapModal.vue pattern; refactor selection logic to single-select with replace behavior.

## Standard Stack

The phase uses existing project dependencies - no new libraries required.

### Core
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| Plotly.js | ^3.1.0 | Timeline chart rendering | Already in use by TimelineCard |
| Vue 2.7 | 2.7.16 | Component framework | Project standard |

### Supporting
| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| StyleManager | Custom | Theme-aware colors | All UI elements |
| FilterManager | Custom | Cross-card filter state | Degree filter integration |

### Alternatives Considered
| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| Custom wheel handler | Plotly scrollZoom:true | Built-in is simpler but doesn't center on cursor |
| CSS modal | portal-vue library | Library adds complexity; CSS modal works fine in existing patterns |
| Buefy modal | Custom modal | Buefy not currently used for modals in interactive dashboard |

**No new installation required** - all patterns can be implemented with existing dependencies.

## Architecture Patterns

### Recommended Project Structure
```
src/plugins/interactive-dashboard/
├── components/
│   ├── cards/
│   │   ├── TimelineCard.vue          # Modified for new features
│   │   └── RideDetailModal.vue       # NEW: Modal for ride detail view
│   └── controls/
│       ├── ComparisonToggle.vue      # Existing pattern reference
│       └── DegreeFilterControl.vue   # NEW: Multi-select degree filter
```

### Pattern 1: Custom Wheel Zoom Handler

**What:** Intercept wheel events and update Plotly x-axis range centered on mouse cursor position
**When to use:** When default scrollZoom behavior doesn't center on cursor
**Example:**
```typescript
// Source: Plotly.js community patterns verified via WebSearch
function handleWheel(e: WheelEvent) {
  e.preventDefault()

  const rect = plotContainer.value!.getBoundingClientRect()
  const graphDiv = plotContainer.value as any
  const xaxis = graphDiv._fullLayout.xaxis

  // Convert pixel position to data coordinates
  // margin.l accounts for left margin
  const mouseX = xaxis.p2d(e.clientX - rect.left - graphDiv._fullLayout.margin.l)

  // Zoom factor: scroll up = zoom in (shrink range)
  const zoomFactor = e.deltaY > 0 ? 1.1 : 0.9

  // Calculate new range centered on cursor
  const xRange = [viewportStart.value, viewportEnd.value]
  const newRange = [
    mouseX - (mouseX - xRange[0]) * zoomFactor,
    mouseX + (xRange[1] - mouseX) * zoomFactor
  ]

  // Clamp to min/max zoom range
  const rangeSize = newRange[1] - newRange[0]
  if (rangeSize < minZoomRange || rangeSize > maxZoomRange) return

  viewportStart.value = Math.max(0, newRange[0])
  viewportEnd.value = Math.min(86400, newRange[1])

  Plotly.relayout(graphDiv, {
    'xaxis.range': [viewportStart.value, viewportEnd.value]
  })
}
```

### Pattern 2: Multi-Select Checkbox Control

**What:** Reusable control component with multiple checkboxes for filtering
**When to use:** Filtering by discrete categories with multi-select capability
**Example:**
```vue
// Based on existing ComparisonToggle.vue pattern
<template lang="pug">
.degree-filter
  .filter-label Degree
  label.degree-option(v-for="option in options" :key="option.value")
    input(
      type="checkbox"
      :checked="selectedValues.has(option.value)"
      @change="toggleValue(option.value)"
    )
    span.option-label {{ option.label }}
</template>

<script setup lang="ts">
interface Props {
  modelValue: Set<number>
}
const props = defineProps<Props>()
const emit = defineEmits(['update:model-value'])

const options = [
  { value: 1, label: '1' },
  { value: 2, label: '2' },
  { value: 3, label: '3+' },
]

const selectedValues = computed(() => props.modelValue)

function toggleValue(value: number) {
  const newSet = new Set(props.modelValue)
  if (newSet.has(value)) {
    newSet.delete(value)
  } else {
    newSet.add(value)
  }
  emit('update:model-value', newSet)
}
</script>
```

### Pattern 3: CSS Modal Component

**What:** Modal overlay using CSS positioning without portal library
**When to use:** Displaying detail views that overlay the dashboard
**Example:**
```vue
// Based on existing SaveMapModal.vue pattern
<template lang="pug">
.ride-detail-modal.fade-in(v-if="visible")
  .modal-backdrop(@click="$emit('close')")
  .modal-content
    header.modal-header
      h2 Ride {{ rideId }}
      button.close-btn(@click="$emit('close')"): i.fa.fa-times

    section.modal-body
      //- Ride summary metrics
      .ride-metrics
        .metric
          span.label Degree:
          span.value {{ rideData.degree }}
        //- ... more metrics

      //- Mini-Gantt for requests
      .requests-section(v-if="requests.length")
        h3 Requests ({{ requests.length }})
        .request-bar(v-for="req in requests" :key="req.id")
          //- Request visualization (port from existing expandedDetail)
</template>
```

### Pattern 4: Single-Select Behavior

**What:** Selection logic that replaces current selection instead of toggling
**When to use:** When only one item should be selected at a time
**Example:**
```typescript
// Current (multi-select toggle):
function handleClick(rideId: string) {
  if (selectedRides.value.has(rideId)) {
    selectedRides.value.delete(rideId)
  } else {
    selectedRides.value.add(rideId)
  }
  selectedRides.value = new Set(selectedRides.value)
}

// New (single-select replace):
function handleClick(rideId: string) {
  // Clear current selection
  selectedRides.value.clear()

  // If clicking different ride, select it
  if (expandedRideId.value !== rideId) {
    selectedRides.value.add(rideId)
    expandedRideId.value = rideId
  } else {
    // Clicking same ride deselects it
    expandedRideId.value = null
  }

  selectedRides.value = new Set(selectedRides.value)
  emit('select', new Set(selectedRides.value))
}
```

### Anti-Patterns to Avoid
- **Using portal-vue for simple modals:** SimWrapper's existing CSS-based modal pattern works without additional dependencies
- **Modifying Plotly scrollZoom directly:** Built-in scrollZoom cannot be customized for cursor centering
- **Filtering data in computed property for degree filter:** Use local filter within TimelineCard, not FilterManager (degree is UI-only filter)

## Don't Hand-Roll

Problems that look simple but have existing solutions:

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Modal overlay positioning | Custom portal/teleport | CSS position:fixed | Existing patterns work; no z-index issues in practice |
| Checkbox styling | Custom checkbox SVGs | Native checkbox + CSS | ComparisonToggle shows native works fine |
| Degree bucketing (3+) | Complex conditional | Simple ternary in filter | `degree >= 3` maps to "3+" |

**Key insight:** The existing TimelineCard already has all the building blocks - we're reorganizing and simplifying, not building from scratch.

## Common Pitfalls

### Pitfall 1: Plotly wheel event interference

**What goes wrong:** Default browser scroll behavior conflicts with zoom
**Why it happens:** Plotly's scrollZoom and custom wheel handlers can conflict
**How to avoid:** Use either built-in scrollZoom OR custom handler, not both. For cursor-centered zoom, disable scrollZoom and use custom handler only.
**Warning signs:** Page scrolls while trying to zoom chart

### Pitfall 2: Degree filter not filtering timeline data

**What goes wrong:** Degree filter changes don't update the chart
**Why it happens:** TimelineCard computes data from `filteredData` prop, which comes from FilterManager
**How to avoid:** Apply degree filter locally within TimelineCard on top of filteredData, before track allocation. Do NOT add degree filter to FilterManager (would affect other cards).
**Warning signs:** Changing degree checkboxes doesn't change visible bars

### Pitfall 3: Modal z-index below fullscreen cards

**What goes wrong:** Modal appears behind fullscreen DataTableCard
**Why it happens:** DataTableCard fullscreen uses z-index 9999
**How to avoid:** Use z-index 10001+ for modal (following existing pattern from DashboardCard fullscreen)
**Warning signs:** Modal is invisible when another card is fullscreen

### Pitfall 4: Selection state not clearing on modal close

**What goes wrong:** Ride remains selected after closing modal
**Why it happens:** Modal close doesn't emit deselection event
**How to avoid:** Modal close should call parent's deselection handler; or keep selection until another ride is clicked
**Warning signs:** Visual selection highlight persists after closing modal

### Pitfall 5: Wheel zoom outside valid time range

**What goes wrong:** Timeline zooms to negative times or beyond 24 hours
**Why it happens:** Zoom calculation doesn't clamp to valid range
**How to avoid:** Clamp viewportStart to Math.max(0, ...) and viewportEnd to Math.min(86400, ...)
**Warning signs:** X-axis shows negative values or values beyond 24:00

## Code Examples

Verified patterns from existing codebase:

### Existing Zoom Implementation (to extend with wheel support)
```typescript
// Source: TimelineCard.vue lines 588-630
function zoomIn() {
  const currentRange = viewportEnd.value - viewportStart.value
  const center = (viewportStart.value + viewportEnd.value) / 2
  const newRange = Math.max(currentRange * 0.5, minZoomRange)

  viewportStart.value = Math.max(0, center - newRange / 2)
  viewportEnd.value = Math.min(86400, center + newRange / 2)
  updateMainChartRange()
}

function updateMainChartRange() {
  if (!plotContainer.value) return
  Plotly.relayout(plotContainer.value as any, {
    'xaxis.range': [viewportStart.value, viewportEnd.value]
  })
}
```

### Existing Modal Pattern (for RideDetailModal.vue)
```vue
// Source: SaveMapModal.vue pattern
<template lang="pug">
.save-map-modal.fade-in
  .modal-content
    h1.blue Save Map
      p.close-button(@click="$emit('close')"): i.fas.fa-times
    //- Modal content

<style scoped>
.save-map-modal {
  position: absolute;
  top: 0;
  bottom: 0;
  left: 0;
  right: 0;
  z-index: 50;
  display: flex;
  flex-direction: column;
  background-color: #00000088;
  padding: 2.5rem;
}

.modal-content {
  margin: 2rem auto auto auto;
  padding: 1.5rem;
  border-radius: 5px;
  filter: drop-shadow(0 0 20px #000011aa);
  background: var(--bgLayerPanel);
}
</style>
```

### Existing Checkbox Control Pattern
```vue
// Source: ComparisonToggle.vue
<template lang="pug">
.comparison-toggle
  label(:class="{ disabled: disabled }")
    input(
      type="checkbox"
      :checked="modelValue"
      :disabled="disabled"
      @change="onChange"
    )
    span.mode-label Comparison
</template>
```

### Existing Mini-Gantt for Requests (to port to modal)
```vue
// Source: TimelineCard.vue lines 33-52
.requests-gantt(v-if="expandedRideRequests.length")
  h5 Requests ({{ expandedRideRequests.length }})
  .request-bar(v-for="req in expandedRideRequests" :key="req.id")
    .request-header
      span.req-id Request {{ req.id }}
      span.req-time(v-if="req.treq") @ {{ formatTime(req.treq) }}
    .request-timeline
      .constraint-bar(:style="getRequestConstraintStyle(req)")
      .actual-bar(:style="getRequestActualStyle(req)")
    .request-metrics
      span.metric(v-if="req.delay !== undefined")
        //- Metrics display
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Multi-select toggle | Single-select replace | Phase 4.1 | Simpler mental model |
| Inline expandable detail | Modal popup | Phase 4.1 | Less visual clutter |
| Button-only zoom | Mouse wheel + buttons | Phase 4.1 | More intuitive interaction |
| All rides visible | Degree filter default >=2 | Phase 4.1 | Focus on pooled rides |

**Deprecated/outdated:**
- Inline `.expanded-detail` section: Being replaced by modal (TIME-05)
- Multi-select Set.add() logic: Being replaced by single-select (TIME-06)

## Open Questions

Things that couldn't be fully resolved:

1. **Zoom control relocation CSS specifics**
   - What we know: Buttons move from `.timeline-controls` to `.minimap-container`
   - What's unclear: Exact positioning (above minimap? overlay? inline?)
   - Recommendation: Implement as floating overlay in minimap corner; adjust based on visual review

2. **Degree 3+ bucketing behavior**
   - What we know: Filter should show "3+" option, not individual values
   - What's unclear: Should 3, 4, 5, etc. be stored separately or as single "3+" flag?
   - Recommendation: Store as individual values internally but display as "3+" in UI; filter with `degree >= 3`

3. **Modal interaction with cross-card linkage**
   - What we know: Modal shows selected ride details
   - What's unclear: Should opening modal emit select event to LinkageManager?
   - Recommendation: Yes, emit select for single ride ID to coordinate with other cards (map, table)

## Sources

### Primary (HIGH confidence)
- TimelineCard.vue - Current implementation analyzed (~1240 lines)
- SaveMapModal.vue - Modal pattern reference
- ComparisonToggle.vue - Checkbox control pattern
- FilterManager.ts - Filter state management pattern
- LinkableCardWrapper.vue - Event emission patterns

### Secondary (MEDIUM confidence)
- [Plotly.js Configuration Options](https://plotly.com/javascript/configuration-options/) - scrollZoom documentation
- [Plotly.js Events](https://plotly.com/javascript/plotlyjs-events/) - plotly_relayout event handling
- Plotly Community Forums - Custom wheel zoom implementation patterns

### Tertiary (LOW confidence)
- [Vue 3 Teleport](https://vuejs.org/guide/built-ins/teleport.html) - Reference only (not available in Vue 2)
- WebSearch results on portal-vue - Not needed, CSS modal pattern sufficient

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - No new dependencies, all existing patterns
- Architecture: HIGH - Clear examples in existing codebase
- Pitfalls: MEDIUM - Based on analysis of similar implementations

**Research date:** 2026-01-22
**Valid until:** Indefinite - patterns are stable within this codebase
