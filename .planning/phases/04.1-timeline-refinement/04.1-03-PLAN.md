# Plan 04.1-03: Modal Detail View and Single-Select Behavior

**Phase:** 4.1 - Timeline Refinement
**Wave:** 2
**Depends On:** 04.1-01, 04.1-02

## Overview

Replace the inline expandable ride detail view with a modal popup, and refactor selection behavior from multi-select toggle to single-select replace. This addresses TIME-05 (modal detail view) and TIME-06 (single-ride selection).

## Files Modified

- `src/plugins/interactive-dashboard/components/cards/RideDetailModal.vue` - NEW: Modal component for ride details
- `src/plugins/interactive-dashboard/components/cards/TimelineCard.vue` - Remove inline detail, integrate modal, change to single-select

## Tasks

<task id="1">
Create `RideDetailModal.vue` component following SaveMapModal.vue pattern:
1. Props interface:
   - `visible: boolean` - Controls modal visibility
   - `rideId: string` - ID of the ride to display
   - `rideData: ExtendedTimelineItem | null` - Ride data with degree, times, constraints
   - `requests: any[]` - Array of request objects for mini-Gantt
2. Emit `close` event for modal dismissal
3. Template structure (Pug):
   - `.ride-detail-modal.fade-in(v-if="visible")` - Outer modal wrapper
   - `.modal-backdrop(@click="$emit('close')")` - Click-to-close backdrop
   - `.modal-content` - Content container with:
     - `header.modal-header` - Title "Ride {rideId}" with close button
     - `section.ride-metrics` - Degree, duration, time window (port from TimelineCard)
     - `section.requests-section(v-if="requests.length")` - Mini-Gantt for requests
4. Port `getRequestConstraintStyle()` and `getRequestActualStyle()` helper functions
5. Port `formatTime()` and `formatDuration()` helper functions (or import from shared utility)
6. Add Escape key listener for modal close
7. Style with z-index 10001 to appear above fullscreen cards:
   - `.ride-detail-modal`: position fixed, inset 0, z-index 10001, flex center
   - `.modal-backdrop`: position absolute, inset 0, background rgba(0,0,0,0.5)
   - `.modal-content`: theme-aware background, padding, border-radius, max-width 600px
</task>

<task id="2" depends_on="1">
Refactor TimelineCard to use modal and single-select:
1. Import RideDetailModal component
2. Add `showModal` ref (boolean, default false)
3. Replace `handleClick()` multi-select logic with single-select:
   ```typescript
   function handleClick(rideId: string) {
     // Clear existing selection
     selectedRides.value.clear()

     // If clicking same ride, just deselect (close modal)
     if (expandedRideId.value === rideId) {
       expandedRideId.value = null
       showModal.value = false
     } else {
       // Select new ride and show modal
       selectedRides.value.add(rideId)
       expandedRideId.value = rideId
       showModal.value = true
     }

     // Trigger reactivity and emit events
     selectedRides.value = new Set(selectedRides.value)
     emit('select', new Set(selectedRides.value))
     // ... filter emit logic unchanged
   }
   ```
4. Add `handleModalClose()` function:
   - Sets `showModal.value = false`
   - Optionally clears selection (or keeps ride selected with highlight)
5. Remove the inline `.expanded-detail` section from template (and its `<transition>`)
6. Add RideDetailModal to template at bottom of component:
   ```pug
   RideDetailModal(
     :visible="showModal"
     :rideId="expandedRideId"
     :rideData="expandedRideData"
     :requests="expandedRideRequests"
     @close="handleModalClose"
   )
   ```
7. Remove `.expanded-detail` CSS and `.slide-down-*` transition styles
</task>

## Verification

<verification>
1. Open dashboard with TimelineCard
2. Click a ride bar - modal should appear with ride details
3. Verify modal shows: Ride ID in header, degree, duration, time window
4. Verify modal shows requests section with mini-Gantt (if ride has request data)
5. Click backdrop or press Escape - modal should close
6. Click close button (X) - modal should close
7. Click a different ride - previous selection should clear, new modal opens
8. Click same ride twice - first click opens modal, second click closes modal
9. Verify only ONE ride can be selected at a time (no multi-select)
10. Verify inline expanded detail panel is GONE (no slide-down animation)
11. Verify modal appears above other cards (z-index correct)
12. Run `npm run test:run` to ensure no regressions
</verification>

## Must-Haves (Goal-Backward)

**Truths (observable behaviors):**
- User clicks ride and sees modal popup (not inline expansion)
- User can only select one ride at a time
- Clicking another ride replaces current selection

**Artifacts:**
- `RideDetailModal.vue` exists with modal UI
- `TimelineCard.vue` no longer has `.expanded-detail` section
- `TimelineCard.vue` has single-select logic in `handleClick()`

**Key Links:**
- `handleClick()` sets `showModal = true` and `expandedRideId = rideId`
- `RideDetailModal` receives `expandedRideData` and `expandedRideRequests` as props
- Modal `@close` triggers `handleModalClose()` which sets `showModal = false`

---
autonomous: true
