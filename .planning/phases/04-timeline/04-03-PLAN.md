---
phase: 04-timeline
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - src/plugins/interactive-dashboard/components/cards/TimelineCard.vue
  - src/dash-panels/_allPanels.ts
autonomous: true

must_haves:
  truths:
    - "User hovers over a bar and sees the ride highlighted in data table"
    - "User clicks a bar to filter other cards to that ride"
    - "User can toggle-select multiple rides (OR filtering)"
    - "Timeline card type can be specified in YAML dashboard config"
  artifacts:
    - path: "src/plugins/interactive-dashboard/components/cards/TimelineCard.vue"
      provides: "Timeline with hover/click interactions"
      min_lines: 350
    - path: "src/dash-panels/_allPanels.ts"
      provides: "Card type registration"
      contains: "timeline"
  key_links:
    - from: "TimelineCard.vue"
      to: "LinkableCardWrapper"
      via: "emit filter/hover/select events"
      pattern: "emit\\(['\"](filter|hover|select)"
    - from: "_allPanels.ts"
      to: "TimelineCard.vue"
      via: "defineAsyncComponent import"
      pattern: "timeline.*TimelineCard"
---

<objective>
Add hover/click interactions to TimelineCard and register it as a dashboard card type for YAML configuration.

Purpose: Enable cross-card coordination (hover highlights in table, click filters to single ride) following the established linkage patterns from HistogramCard and PieChartCard. Register the card type so users can add `type: timeline` to their YAML configs.

Output: TimelineCard emits hover/select/filter events that integrate with LinkableCardWrapper, and card type is registered in _allPanels.ts.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-timeline/04-CONTEXT.md
@.planning/phases/04-timeline/04-02-SUMMARY.md

@src/plugins/interactive-dashboard/components/cards/HistogramCard.vue (click pattern)
@src/plugins/interactive-dashboard/components/cards/PieChartCard.vue (hover pattern)
@src/dash-panels/_allPanels.ts (registration pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement hover event handling</name>
  <files>
    src/plugins/interactive-dashboard/components/cards/TimelineCard.vue
  </files>
  <action>
Add Plotly hover event handling to emit hover events for cross-card coordination.

**Plotly hover event binding (in renderChart after newPlot):**
```typescript
// After Plotly.newPlot(...)
plotContainer.value.on('plotly_hover', handleHover)
plotContainer.value.on('plotly_unhover', handleUnhover)
```

**Hover handler:**
```typescript
function handleHover(data: any) {
  // Get the ride ID from customdata
  const point = data.points[0]

  // Skip constraint window trace (no customdata)
  if (!point.customdata) return

  const rideId = point.customdata.id
  debugLog('[TimelineCard] Hover:', rideId)

  // Emit hover event with Set containing single ID
  emit('hover', new Set([rideId]))
}

function handleUnhover() {
  // Clear hover state
  emit('hover', new Set())
}
```

**Visual feedback for external hover (from hoveredIds prop):**
```typescript
watch(() => props.hoveredIds, (newIds) => {
  if (!plotContainer.value || !newIds) return

  // Find indices of hovered rides
  const hoveredIndices = timelineData.value
    .map((item, idx) => newIds.has(item.id) ? idx : -1)
    .filter(idx => idx >= 0)

  // Update bar opacity/styling via Plotly.restyle
  // Highlight hovered, dim others
  if (hoveredIndices.length > 0) {
    const colors = timelineData.value.map((item, idx) => {
      if (newIds.has(item.id)) {
        return getDegreeColor(item.degree)  // Full color
      }
      return applyOpacity(getDegreeColor(item.degree), 0.3)  // Dimmed
    })
    Plotly.restyle(plotContainer.value, { 'marker.color': [colors] }, [1])  // Update actual trace only
  } else {
    // Reset to normal colors
    const colors = timelineData.value.map(item => getDegreeColor(item.degree))
    Plotly.restyle(plotContainer.value, { 'marker.color': [colors] }, [1])
  }
}, { deep: true })
```

**Helper for opacity:**
```typescript
function applyOpacity(hexColor: string, opacity: number): string {
  // Convert hex to rgba with opacity
  const r = parseInt(hexColor.slice(1, 3), 16)
  const g = parseInt(hexColor.slice(3, 5), 16)
  const b = parseInt(hexColor.slice(5, 7), 16)
  return `rgba(${r}, ${g}, ${b}, ${opacity})`
}
```
  </action>
  <verify>
- Hovering over timeline bar emits hover event
- Data table highlights corresponding row when hovering timeline
- Timeline dims non-hovered bars when hoveredIds prop changes
- Moving off bar clears hover state
  </verify>
  <done>
Timeline hover events integrate with cross-card linkage system
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement click/select event handling</name>
  <files>
    src/plugins/interactive-dashboard/components/cards/TimelineCard.vue
  </files>
  <action>
Add Plotly click event handling for toggle selection (OR filtering) following HistogramCard pattern.

**State for selected rides:**
```typescript
const selectedRides = ref<Set<string>>(new Set())
```

**Plotly click event binding:**
```typescript
plotContainer.value.on('plotly_click', handleClick)
```

**Click handler with toggle behavior:**
```typescript
function handleClick(data: any) {
  const point = data.points[0]

  // Skip constraint window trace
  if (!point.customdata) return

  const rideId = point.customdata.id
  debugLog('[TimelineCard] Click:', rideId)

  // Toggle selection (matching HistogramCard behavior)
  if (selectedRides.value.has(rideId)) {
    selectedRides.value.delete(rideId)
  } else {
    selectedRides.value.add(rideId)
  }

  // Emit select event for visual highlighting
  emit('select', new Set(selectedRides.value))

  // Emit filter event for cross-card filtering
  if (props.linkage?.type === 'filter') {
    const filterColumn = props.linkage.column || props.idColumn || 'ride_id'
    emit('filter',
      `timeline-${props.title || 'rides'}`,
      filterColumn,
      new Set(selectedRides.value),
      'categorical'
    )
  }

  // Update visual selection state
  updateSelectionVisuals()
}
```

**Visual selection feedback:**
```typescript
function updateSelectionVisuals() {
  if (!plotContainer.value) return

  // Add selection outline to selected bars
  const lineWidths = timelineData.value.map(item =>
    selectedRides.value.has(item.id) ? 2 : 1
  )
  const lineColors = timelineData.value.map(item =>
    selectedRides.value.has(item.id)
      ? StyleManager.getInstance().getColor('interaction.selected')
      : getThemeColors().bgColor
  )

  Plotly.restyle(plotContainer.value, {
    'marker.line.width': [lineWidths],
    'marker.line.color': [lineColors],
  }, [1])  // Update actual trace only
}
```

**Watch for external selection changes (selectedIds prop):**
```typescript
watch(() => props.selectedIds, (newIds) => {
  if (!newIds) return

  // Sync internal state with external selection
  selectedRides.value = new Set(
    [...newIds].map(id => String(id))
  )
  updateSelectionVisuals()
}, { deep: true })
```

**Clear selection on escape key:**
```typescript
function handleKeydown(e: KeyboardEvent) {
  if (e.key === 'Escape' && selectedRides.value.size > 0) {
    selectedRides.value.clear()
    emit('select', new Set())
    if (props.linkage?.type === 'filter') {
      emit('filter', `timeline-${props.title || 'rides'}`, props.linkage.column, new Set(), 'categorical')
    }
    updateSelectionVisuals()
  }
}

onMounted(() => {
  window.addEventListener('keydown', handleKeydown)
})

onUnmounted(() => {
  window.removeEventListener('keydown', handleKeydown)
})
```
  </action>
  <verify>
- Clicking a bar adds it to selection (visual highlight)
- Clicking a selected bar removes it from selection
- Other cards filter to show only selected rides
- Escape key clears selection
- External selectedIds changes update timeline visuals
  </verify>
  <done>
Timeline click events enable toggle selection with cross-card filtering
  </done>
</task>

<task type="auto">
  <name>Task 3: Register timeline card type</name>
  <files>
    src/dash-panels/_allPanels.ts
  </files>
  <action>
Register the TimelineCard component in the panel lookup so it can be used via YAML config.

**Add to panelLookup in _allPanels.ts:**
```typescript
// In the panelLookup object, add:
'timeline': defineAsyncComponent(() => import('@/plugins/interactive-dashboard/components/cards/TimelineCard.vue')),
```

**Place it alphabetically near other interactive dashboard cards (after 'text', before 'tile').**

**Emit isLoaded event in TimelineCard:**
```typescript
// At end of renderChart():
emit('isLoaded')
```

**YAML usage example (for documentation):**
```yaml
layout:
  row1:
    - type: timeline
      title: Ride Timeline
      idColumn: ride_id
      startColumn: start_time
      endColumn: end_time
      degreeColumn: degree
      linkage:
        type: filter
        column: ride_id
        behavior: toggle
```
  </action>
  <verify>
- `type: timeline` in YAML config renders TimelineCard
- Card appears in dashboard alongside other cards
- `npm run build` succeeds with no errors
- Card emits isLoaded event after rendering
  </verify>
  <done>
TimelineCard registered as 'timeline' card type in _allPanels.ts, usable in YAML configs
  </done>
</task>

</tasks>

<verification>
1. Hovering timeline bar highlights row in data table
2. Hovering data table row highlights bar in timeline
3. Clicking bar filters other cards to that ride
4. Toggle selection works (click to add/remove)
5. Escape clears selection
6. `type: timeline` works in YAML config
7. Card emits isLoaded event
8. No TypeScript errors
</verification>

<success_criteria>
- Hover events emit correctly and respond to external hover state
- Click events implement toggle selection with OR filtering
- Selection visuals show clear feedback (outline/highlight)
- Card type registered and works in YAML
- Full integration with LinkableCardWrapper pattern
</success_criteria>

<output>
After completion, create `.planning/phases/04-timeline/04-03-SUMMARY.md`
</output>
