---
phase: 04-timeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/plugins/interactive-dashboard/utils/trackAllocator.ts
  - src/plugins/interactive-dashboard/components/cards/TimelineCard.vue
autonomous: true

must_haves:
  truths:
    - "Timeline card renders in dashboard when type: timeline specified in YAML"
    - "Rides are assigned to swim lanes without overlapping bars"
    - "Track allocation minimizes vertical space usage"
  artifacts:
    - path: "src/plugins/interactive-dashboard/utils/trackAllocator.ts"
      provides: "Greedy interval partitioning algorithm"
      exports: ["allocateTracks", "TimelineItem"]
    - path: "src/plugins/interactive-dashboard/components/cards/TimelineCard.vue"
      provides: "Timeline card component scaffold"
      min_lines: 100
  key_links:
    - from: "TimelineCard.vue"
      to: "trackAllocator.ts"
      via: "import allocateTracks"
      pattern: "import.*allocateTracks.*from.*trackAllocator"
---

<objective>
Create the track allocation algorithm and TimelineCard component scaffold for Gantt-style timeline visualization.

Purpose: Establish the foundational data transformation (rides to swim lanes) and component structure that subsequent plans will build upon. The track allocator is a pure function that can be tested in isolation.

Output: Working trackAllocator.ts utility with unit tests, and TimelineCard.vue scaffold that renders a placeholder with correct props interface.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-timeline/04-CONTEXT.md
@.planning/phases/04-timeline/04-RESEARCH.md

@src/plugins/interactive-dashboard/components/cards/HistogramCard.vue (pattern reference)
@src/plugins/interactive-dashboard/components/cards/ScatterCard.vue (pattern reference)
@src/plugins/interactive-dashboard/utils/statistics.ts (utility pattern reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create trackAllocator utility</name>
  <files>
    src/plugins/interactive-dashboard/utils/trackAllocator.ts
    src/plugins/interactive-dashboard/utils/__tests__/trackAllocator.test.ts
  </files>
  <action>
Create the track allocation utility using the greedy interval partitioning algorithm from research.

**Interface:**
```typescript
export interface TimelineItem {
  id: string
  start: number  // seconds from midnight
  end: number    // seconds from midnight
}

export interface TrackAllocation {
  trackIndex: number
  totalTracks: number
}

/**
 * Allocate timeline items to tracks (swim lanes) using greedy interval partitioning.
 * Returns a Map from item ID to track index.
 * O(n log n) time complexity due to initial sort.
 */
export function allocateTracks(items: TimelineItem[]): Map<string, TrackAllocation>
```

**Algorithm (from research Pattern 3):**
1. Sort items by start time (ascending)
2. Maintain array of track end times
3. For each item: find first track where item fits (end <= item.start), or create new track
4. Assign item to that track, update track end time
5. Return map of id -> { trackIndex, totalTracks }

**Unit tests (in __tests__/trackAllocator.test.ts):**
- Empty array returns empty map
- Single item gets track 0
- Non-overlapping items reuse tracks
- Overlapping items get different tracks
- Track count equals max concurrent items
- Items sorted by start time internally (input order doesn't matter)
- Edge case: items with same start time
- Edge case: items with zero duration (start === end)
  </action>
  <verify>
`npm run test:run -- trackAllocator` passes all unit tests
  </verify>
  <done>
trackAllocator.ts exports allocateTracks function that correctly assigns rides to minimum number of swim lanes
  </done>
</task>

<task type="auto">
  <name>Task 2: Create TimelineCard component scaffold</name>
  <files>
    src/plugins/interactive-dashboard/components/cards/TimelineCard.vue
  </files>
  <action>
Create the TimelineCard Vue component scaffold following existing card patterns (HistogramCard, ScatterCard).

**Template (Pug):**
```pug
.timeline-card
  .plot-container(ref="plotContainer")
```

**Props interface (follow ScatterCard pattern):**
```typescript
interface Props {
  title?: string
  filteredData?: any[]        // From LinkableCardWrapper
  baselineData?: any[]        // For comparison mode
  showComparison?: boolean    // Comparison mode toggle
  hoveredIds?: Set<any>       // Hovered IDs from linkage
  selectedIds?: Set<any>      // Selected IDs from linkage
  idColumn?: string           // Column for ride ID (default: 'ride_id')
  startColumn?: string        // Column for start time (default: 'start_time')
  endColumn?: string          // Column for end time (default: 'end_time')
  degreeColumn?: string       // Column for ride degree (default: 'degree')
  linkage?: object            // Linkage config
  tableConfig?: TableConfig   // For column formats
}
```

**Script setup:**
- Import: ref, watch, onMounted, onUnmounted, computed, nextTick
- Import: Plotly from 'plotly.js/dist/plotly'
- Import: StyleManager from '../../managers/StyleManager'
- Import: globalStore from '@/store'
- Import: allocateTracks from '../../utils/trackAllocator'
- Import: debugLog from '../../utils/debug'

**Computed properties to scaffold (implementations in Plan 02):**
- `timelineData`: Transform filteredData into TimelineItem[] using column props
- `trackAllocation`: Call allocateTracks(timelineData)
- `isDarkMode`: From globalStore.state.isDarkMode

**Emit events:**
- filter: [filterId, column, values, filterType]
- hover: [ids: Set<any>]
- select: [ids: Set<any>]
- isLoaded: []

**Lifecycle:**
- onMounted: Call renderChart() (placeholder for now)
- onUnmounted: Cleanup resize observer

**Styling:**
```scss
.timeline-card {
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;

  .plot-container {
    flex: 1;
    min-height: 200px;
  }
}
```
  </action>
  <verify>
- Component file exists with correct props interface
- Component imports trackAllocator
- TypeScript compiles without errors: `npm run build 2>&1 | grep -i error || echo "No errors"`
  </verify>
  <done>
TimelineCard.vue exists with correct props interface, imports trackAllocator, and follows established card patterns
  </done>
</task>

</tasks>

<verification>
1. trackAllocator.ts exists with allocateTracks export
2. trackAllocator unit tests pass
3. TimelineCard.vue exists with correct structure
4. TypeScript compilation succeeds
5. No regressions in existing card tests
</verification>

<success_criteria>
- Track allocation algorithm implemented with O(n log n) complexity
- TimelineCard scaffold matches existing card patterns
- All unit tests pass
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-timeline/04-01-SUMMARY.md`
</output>
