---
phase: 04-timeline
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/plugins/interactive-dashboard/components/cards/TimelineCard.vue
autonomous: true

must_haves:
  truths:
    - "User sees horizontal bars representing rides positioned by time"
    - "User sees nested bars: outer gray (constraint window), inner colored (actual travel)"
    - "User sees bars colored by degree (1-passenger, 2-passenger, 3+ passengers)"
    - "User sees 24-hour time axis with formatted labels"
  artifacts:
    - path: "src/plugins/interactive-dashboard/components/cards/TimelineCard.vue"
      provides: "Plotly-based timeline rendering"
      min_lines: 250
  key_links:
    - from: "TimelineCard.vue"
      to: "Plotly"
      via: "newPlot and relayout calls"
      pattern: "Plotly\\.(newPlot|relayout)"
    - from: "TimelineCard.vue"
      to: "StyleManager"
      via: "getColor for theme colors"
      pattern: "styleManager\\.getColor"
---

<objective>
Implement Plotly bar rendering for the timeline with nested overlay bars showing constraint windows and actual travel time, colored by ride degree.

Purpose: Transform the TimelineCard scaffold into a functional Gantt-style visualization using Plotly.js horizontal bars with the `base` property for positioning and `barmode: 'overlay'` for nested bars.

Output: TimelineCard renders rides as horizontal bars with outer constraint window (gray) and inner actual travel time (degree-colored), positioned in swim lanes on a 24-hour time axis.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-timeline/04-CONTEXT.md
@.planning/phases/04-timeline/04-RESEARCH.md
@.planning/phases/04-timeline/04-01-SUMMARY.md

@src/plugins/interactive-dashboard/components/cards/HistogramCard.vue (Plotly pattern)
@src/plugins/interactive-dashboard/components/cards/TimelineCard.vue (from Plan 01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Plotly bar traces for timeline</name>
  <files>
    src/plugins/interactive-dashboard/components/cards/TimelineCard.vue
  </files>
  <action>
Implement the core Plotly rendering with horizontal bar traces.

**Data transformation (timelineData computed):**
```typescript
const timelineData = computed(() => {
  if (!props.filteredData?.length) return []

  return props.filteredData.map(row => ({
    id: String(row[props.idColumn || 'ride_id']),
    start: Number(row[props.startColumn || 'start_time']),
    end: Number(row[props.endColumn || 'end_time']),
    degree: Number(row[props.degreeColumn || 'degree']) || 1,
    // For constraint window (if available in data)
    earliestPickup: row.earliest_departure ?? row[props.startColumn || 'start_time'],
    latestDropoff: row.latest_arrival ?? row[props.endColumn || 'end_time'],
  }))
})
```

**Plotly traces (two traces with barmode: 'overlay'):**

1. **Constraint window trace** (outer, wider, gray):
```typescript
const constraintTrace: Partial<Plotly.PlotData> = {
  type: 'bar',
  orientation: 'h',
  name: 'Constraint Window',
  y: trackIndices,  // From trackAllocation
  x: constraintDurations,  // latestDropoff - earliestPickup
  base: earliestPickupTimes,
  marker: {
    color: 'rgba(156, 163, 175, 0.3)',  // Gray with transparency
    line: { width: 0 }
  },
  width: 0.7,
  hoverinfo: 'skip',  // No hover on constraint bar
  showlegend: false,
}
```

2. **Actual travel trace** (inner, narrower, colored by degree):
```typescript
const actualTrace: Partial<Plotly.PlotData> = {
  type: 'bar',
  orientation: 'h',
  name: 'Actual Travel',
  y: trackIndices,
  x: actualDurations,  // end - start
  base: startTimes,
  marker: {
    color: degreeColors,  // Array of colors based on degree
    line: { color: bgColor, width: 1 }
  },
  width: 0.4,
  customdata: rides,  // Full ride data for hover/click
  hovertemplate: '<b>Ride %{customdata.id}</b><br>' +
                 'Start: %{customdata.startFormatted}<br>' +
                 'End: %{customdata.endFormatted}<br>' +
                 'Degree: %{customdata.degree}<extra></extra>',
  showlegend: false,
}
```

**Degree color mapping:**
```typescript
function getDegreeColor(degree: number): string {
  const styleManager = StyleManager.getInstance()
  if (degree === 1) return styleManager.getCategoricalColor(0)  // Blue-ish
  if (degree === 2) return styleManager.getCategoricalColor(1)  // Orange-ish
  return styleManager.getCategoricalColor(2)  // Green-ish for 3+
}
```

**Layout configuration:**
```typescript
const layout: Partial<Plotly.Layout> = {
  barmode: 'overlay',
  paper_bgcolor: bgColor,
  plot_bgcolor: bgColor,
  margin: { l: 40, r: 20, t: 20, b: 60 },
  xaxis: {
    title: { text: 'Time of Day', font: { color: textColor } },
    tickmode: 'array',
    tickvals: generateTimeTickVals(),  // Every 2 hours
    ticktext: generateTimeTickText(),  // HH:MM format
    tickfont: { color: textColor },
    range: [0, 86400],  // Full 24 hours in seconds
    gridcolor: gridColor,
    zerolinecolor: gridColor,
  },
  yaxis: {
    title: { text: '', font: { color: textColor } },
    tickmode: 'array',
    tickvals: [],  // No y-axis labels (anonymous tracks)
    showgrid: false,
    zeroline: false,
    autorange: 'reversed',  // Track 0 at top
  },
  hovermode: 'closest',
  dragmode: 'pan',
}
```
  </action>
  <verify>
- Timeline renders with horizontal bars
- Bars show constraint window (gray) behind actual travel (colored)
- Y-axis shows swim lanes without labels
- X-axis shows 24-hour time with HH:MM labels
- `npm run dev` and visually verify with test data
  </verify>
  <done>
Timeline displays horizontal bars with nested constraint/actual windows, colored by degree, on 24-hour axis
  </done>
</task>

<task type="auto">
  <name>Task 2: Add time formatting and resize handling</name>
  <files>
    src/plugins/interactive-dashboard/components/cards/TimelineCard.vue
  </files>
  <action>
Add time formatting utilities and resize handling following existing card patterns.

**Time formatting helper:**
```typescript
function formatTime(seconds: number): string {
  const hours = Math.floor(seconds / 3600)
  const minutes = Math.floor((seconds % 3600) / 60)
  return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`
}

function generateTimeTickVals(): number[] {
  // Every 2 hours: 0, 7200, 14400, ...
  return Array.from({ length: 13 }, (_, i) => i * 7200)
}

function generateTimeTickText(): string[] {
  return generateTimeTickVals().map(formatTime)
}
```

**Resize observer (from HistogramCard pattern):**
```typescript
let resizeObserver: ResizeObserver | null = null

onMounted(() => {
  if (plotContainer.value) {
    resizeObserver = new ResizeObserver(() => {
      nextTick(() => {
        if (plotContainer.value) {
          Plotly.Plots.resize(plotContainer.value)
        }
      })
    })
    resizeObserver.observe(plotContainer.value)
  }
  renderChart()
})

onUnmounted(() => {
  resizeObserver?.disconnect()
  if (plotContainer.value) {
    Plotly.purge(plotContainer.value)
  }
})
```

**Watch for data changes:**
```typescript
watch(
  [() => props.filteredData, () => isDarkMode.value],
  () => { renderChart() },
  { deep: true }
)
```

**Window resize handler:**
```typescript
function handleWindowResize() {
  if (plotContainer.value) {
    Plotly.Plots.resize(plotContainer.value)
  }
}

onMounted(() => {
  window.addEventListener('resize', handleWindowResize)
})

onUnmounted(() => {
  window.removeEventListener('resize', handleWindowResize)
})
```

**Theme-aware colors from StyleManager:**
```typescript
function getThemeColors() {
  const styleManager = StyleManager.getInstance()
  return {
    bgColor: styleManager.getColor('theme.background.primary'),
    textColor: styleManager.getColor('theme.text.primary'),
    gridColor: styleManager.getColor('theme.border.default'),
  }
}
```
  </action>
  <verify>
- Timeline resizes correctly when card is resized
- Timeline redraws when data changes
- Theme colors update when dark mode toggles
- Time axis shows formatted HH:MM labels
  </verify>
  <done>
Timeline handles resize events, theme changes, and displays properly formatted time axis
  </done>
</task>

</tasks>

<verification>
1. Timeline renders horizontal bars positioned by start/end time
2. Nested bars visible: outer constraint (gray), inner actual (colored)
3. Bars colored by degree (3 distinct colors)
4. 24-hour time axis with HH:MM labels
5. Resize handling works correctly
6. Theme changes apply correctly
7. No TypeScript errors
</verification>

<success_criteria>
- Bars render at correct positions using Plotly base property
- Constraint and actual traces overlay correctly
- Degree coloring works with StyleManager colors
- Timeline responds to resize and theme changes
- Time axis readable with 2-hour tick marks
</success_criteria>

<output>
After completion, create `.planning/phases/04-timeline/04-02-SUMMARY.md`
</output>
