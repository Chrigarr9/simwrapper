---
phase: 04-timeline
plan: 04
type: execute
wave: 4
depends_on: ["04-03"]
files_modified:
  - src/plugins/interactive-dashboard/components/cards/TimelineCard.vue
autonomous: true

must_haves:
  truths:
    - "User can zoom in/out on timeline using plus/minus buttons"
    - "User can navigate timeline using minimap at bottom"
    - "User clicks a ride bar and sees expanded detail view with per-request information"
    - "Expanded view shows stacked mini-Gantt for requests within that ride"
  artifacts:
    - path: "src/plugins/interactive-dashboard/components/cards/TimelineCard.vue"
      provides: "Timeline with zoom, minimap, and expand features"
      min_lines: 500
  key_links:
    - from: "TimelineCard zoom controls"
      to: "Plotly relayout"
      via: "xaxis.range update"
      pattern: "Plotly\\.relayout.*xaxis\\.range"
---

<objective>
Add zoom controls, minimap navigation, and expandable ride detail view to the TimelineCard.

Purpose: Enable users to navigate large timelines (1800+ rides) efficiently and drill into individual ride details showing per-request timing information. The minimap provides context for the current viewport position.

Output: Timeline with zoom +/- buttons, bottom minimap showing full 24-hour overview with viewport indicator, and click-to-expand ride detail panel.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-timeline/04-CONTEXT.md
@.planning/phases/04-timeline/04-RESEARCH.md
@.planning/phases/04-timeline/04-03-SUMMARY.md

@src/plugins/interactive-dashboard/components/cards/TimelineCard.vue (from Plan 03)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement zoom controls and minimap</name>
  <files>
    src/plugins/interactive-dashboard/components/cards/TimelineCard.vue
  </files>
  <action>
Add zoom controls (+/- buttons) and a minimap for timeline navigation.

**Template updates (Pug):**
```pug
.timeline-card
  .timeline-controls
    button.zoom-btn(@click="zoomIn" title="Zoom in")
      i.fa.fa-plus
    button.zoom-btn(@click="zoomOut" title="Zoom out")
      i.fa.fa-minus
    button.zoom-btn(@click="resetZoom" title="Reset zoom")
      i.fa.fa-compress

  .plot-container(ref="plotContainer")

  .minimap-container
    .minimap(ref="minimapContainer")
    .viewport-indicator(:style="viewportIndicatorStyle" @mousedown="startMinimapDrag")
```

**Zoom state:**
```typescript
const viewportStart = ref(0)      // seconds
const viewportEnd = ref(86400)    // 24 hours in seconds
const minZoomRange = 3600         // 1 hour minimum
const maxZoomRange = 86400        // 24 hours maximum
```

**Zoom functions:**
```typescript
function zoomIn() {
  const currentRange = viewportEnd.value - viewportStart.value
  const center = (viewportStart.value + viewportEnd.value) / 2
  const newRange = Math.max(currentRange * 0.5, minZoomRange)

  viewportStart.value = Math.max(0, center - newRange / 2)
  viewportEnd.value = Math.min(86400, center + newRange / 2)
  updateMainChartRange()
}

function zoomOut() {
  const currentRange = viewportEnd.value - viewportStart.value
  const center = (viewportStart.value + viewportEnd.value) / 2
  const newRange = Math.min(currentRange * 2, maxZoomRange)

  viewportStart.value = Math.max(0, center - newRange / 2)
  viewportEnd.value = Math.min(86400, center + newRange / 2)
  updateMainChartRange()
}

function resetZoom() {
  viewportStart.value = 0
  viewportEnd.value = 86400
  updateMainChartRange()
}

function updateMainChartRange() {
  if (!plotContainer.value) return
  Plotly.relayout(plotContainer.value, {
    'xaxis.range': [viewportStart.value, viewportEnd.value]
  })
}
```

**Minimap rendering (second, smaller Plotly chart):**
```typescript
const minimapContainer = ref<HTMLElement>()

function renderMinimap() {
  if (!minimapContainer.value || !timelineData.value.length) return

  const { bgColor, textColor, gridColor } = getThemeColors()

  // Simplified bars for minimap (no constraint windows, just actuals)
  const trace: Partial<Plotly.PlotData> = {
    type: 'bar',
    orientation: 'h',
    y: trackIndices.value,
    x: durations.value,
    base: startTimes.value,
    marker: {
      color: 'rgba(59, 130, 246, 0.5)',  // Blue with transparency
      line: { width: 0 }
    },
    width: 0.8,
    hoverinfo: 'skip',
  }

  const layout: Partial<Plotly.Layout> = {
    paper_bgcolor: bgColor,
    plot_bgcolor: bgColor,
    margin: { l: 0, r: 0, t: 0, b: 20 },
    xaxis: {
      range: [0, 86400],
      tickmode: 'array',
      tickvals: [0, 21600, 43200, 64800, 86400],
      ticktext: ['00', '06', '12', '18', '24'],
      tickfont: { size: 9, color: textColor },
      showgrid: false,
    },
    yaxis: {
      visible: false,
      autorange: 'reversed',
    },
    height: 40,
  }

  Plotly.newPlot(minimapContainer.value, [trace], layout, { staticPlot: true, responsive: true })
}
```

**Viewport indicator (CSS overlay on minimap):**
```typescript
const viewportIndicatorStyle = computed(() => {
  const totalWidth = 100  // percentage
  const left = (viewportStart.value / 86400) * totalWidth
  const width = ((viewportEnd.value - viewportStart.value) / 86400) * totalWidth

  return {
    left: `${left}%`,
    width: `${width}%`,
    backgroundColor: 'rgba(59, 130, 246, 0.3)',
    border: '1px solid rgba(59, 130, 246, 0.8)',
  }
})
```

**Minimap click to navigate:**
```typescript
function handleMinimapClick(e: MouseEvent) {
  const rect = minimapContainer.value?.getBoundingClientRect()
  if (!rect) return

  const clickX = e.clientX - rect.left
  const clickPercent = clickX / rect.width
  const clickTime = clickPercent * 86400

  // Center viewport on clicked time
  const currentRange = viewportEnd.value - viewportStart.value
  viewportStart.value = Math.max(0, clickTime - currentRange / 2)
  viewportEnd.value = Math.min(86400, viewportStart.value + currentRange)
  updateMainChartRange()
}

onMounted(() => {
  minimapContainer.value?.addEventListener('click', handleMinimapClick)
  renderMinimap()
})
```

**Listen to main chart pan/zoom events:**
```typescript
// After main chart newPlot:
plotContainer.value.on('plotly_relayout', (eventData: any) => {
  if (eventData['xaxis.range[0]'] !== undefined) {
    viewportStart.value = eventData['xaxis.range[0]']
    viewportEnd.value = eventData['xaxis.range[1]']
  }
})
```

**Styling for controls and minimap:**
```scss
.timeline-controls {
  display: flex;
  gap: 4px;
  padding: 4px;

  .zoom-btn {
    padding: 4px 8px;
    border: 1px solid var(--dashboard-border-default, #e5e7eb);
    border-radius: 4px;
    background: var(--dashboard-background-primary);
    cursor: pointer;

    &:hover {
      background: var(--dashboard-background-secondary);
    }
  }
}

.minimap-container {
  position: relative;
  height: 50px;
  padding: 5px 0;

  .minimap {
    height: 40px;
  }

  .viewport-indicator {
    position: absolute;
    top: 5px;
    height: 40px;
    cursor: grab;
    pointer-events: auto;

    &:active {
      cursor: grabbing;
    }
  }
}
```
  </action>
  <verify>
- Zoom in/out buttons change timeline x-axis range
- Reset button returns to full 24-hour view
- Minimap shows overview of all rides
- Viewport indicator reflects current zoom range
- Clicking minimap navigates main chart
- Panning main chart updates viewport indicator
  </verify>
  <done>
Timeline has zoom controls and minimap navigation
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement expandable ride detail view</name>
  <files>
    src/plugins/interactive-dashboard/components/cards/TimelineCard.vue
  </files>
  <action>
Add expandable detail view that shows per-request information when a ride is clicked.

**State for expanded ride:**
```typescript
const expandedRideId = ref<string | null>(null)
```

**Template for expanded detail (Pug):**
```pug
.timeline-card
  .timeline-controls
    //- ... zoom controls ...

  .plot-container(ref="plotContainer")

  //- Expanded detail panel
  transition(name="slide-down")
    .expanded-detail(v-if="expandedRideId && expandedRideData")
      .detail-header
        h4 Ride {{ expandedRideId }}
        button.close-btn(@click="expandedRideId = null")
          i.fa.fa-times

      .detail-content
        .ride-summary
          .metric
            span.label Degree:
            span.value {{ expandedRideData.degree }}
          .metric
            span.label Duration:
            span.value {{ formatDuration(expandedRideData.end - expandedRideData.start) }}
          .metric
            span.label Time Window:
            span.value {{ formatTime(expandedRideData.earliestPickup) }} - {{ formatTime(expandedRideData.latestDropoff) }}

        //- Mini-Gantt for requests (if request data available)
        .requests-gantt(v-if="expandedRideRequests.length")
          h5 Requests ({{ expandedRideRequests.length }})
          .request-bar(v-for="req in expandedRideRequests" :key="req.id")
            .request-label {{ req.id }}
            .request-timeline
              .constraint-bar(:style="getRequestConstraintStyle(req)")
              .actual-bar(:style="getRequestActualStyle(req)")
            .request-metrics
              span.metric Delay: {{ formatDuration(req.delay) }}
              span.metric Wait: {{ formatDuration(req.wait_time) }}

  .minimap-container
    //- ... minimap ...
```

**Computed for expanded ride data:**
```typescript
const expandedRideData = computed(() => {
  if (!expandedRideId.value) return null
  return timelineData.value.find(item => item.id === expandedRideId.value)
})

// Requests for expanded ride (if available in data)
const expandedRideRequests = computed(() => {
  if (!expandedRideId.value || !props.filteredData) return []

  // Look for requests linked to this ride
  // This assumes request data has a ride_id column matching
  return props.filteredData
    .filter(row => String(row.ride_id) === expandedRideId.value && row.request_id)
    .map(row => ({
      id: row.request_id,
      treq: row.treq,
      earliest_departure: row.earliest_departure,
      latest_arrival: row.latest_arrival,
      delay: row.delay || 0,
      wait_time: row.wait_time || 0,
    }))
})
```

**Modify click handler to toggle expansion:**
```typescript
function handleClick(data: any) {
  const point = data.points[0]
  if (!point.customdata) return

  const rideId = point.customdata.id

  // Toggle expansion (only one ride expanded at a time)
  if (expandedRideId.value === rideId) {
    expandedRideId.value = null
  } else {
    expandedRideId.value = rideId
  }

  // Continue with existing selection logic...
  // (keep the toggle selection code from Task 2 of Plan 03)
}
```

**Helper for request bar styling:**
```typescript
function getRequestConstraintStyle(req: any) {
  const totalRange = 86400  // or use current viewport
  const start = req.earliest_departure / totalRange * 100
  const width = (req.latest_arrival - req.earliest_departure) / totalRange * 100

  return {
    left: `${start}%`,
    width: `${width}%`,
    backgroundColor: 'rgba(156, 163, 175, 0.3)',
  }
}

function getRequestActualStyle(req: any) {
  const totalRange = 86400
  const start = req.treq / totalRange * 100
  const width = 2  // Fixed small width for pickup marker

  return {
    left: `${start}%`,
    width: `${width}%`,
    backgroundColor: getDegreeColor(1),
  }
}

function formatDuration(seconds: number): string {
  if (seconds < 60) return `${seconds}s`
  const minutes = Math.floor(seconds / 60)
  const remainingSeconds = seconds % 60
  if (minutes < 60) return remainingSeconds ? `${minutes}m ${remainingSeconds}s` : `${minutes}m`
  const hours = Math.floor(minutes / 60)
  const remainingMinutes = minutes % 60
  return `${hours}h ${remainingMinutes}m`
}
```

**Styling for expanded detail:**
```scss
.expanded-detail {
  border-top: 1px solid var(--dashboard-border-default);
  padding: 12px;
  background: var(--dashboard-background-secondary);
  max-height: 200px;
  overflow-y: auto;

  .detail-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;

    h4 {
      margin: 0;
      font-size: 14px;
    }

    .close-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
    }
  }

  .ride-summary {
    display: flex;
    gap: 16px;
    margin-bottom: 12px;

    .metric {
      .label {
        color: var(--dashboard-text-secondary);
        margin-right: 4px;
      }
      .value {
        font-weight: 500;
      }
    }
  }

  .requests-gantt {
    h5 {
      margin: 0 0 8px 0;
      font-size: 12px;
    }

    .request-bar {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;

      .request-label {
        width: 60px;
        font-size: 11px;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .request-timeline {
        position: relative;
        flex: 1;
        height: 16px;
        background: var(--dashboard-background-primary);
        border-radius: 2px;

        .constraint-bar, .actual-bar {
          position: absolute;
          top: 0;
          height: 100%;
          border-radius: 2px;
        }
      }

      .request-metrics {
        display: flex;
        gap: 8px;
        font-size: 10px;
        color: var(--dashboard-text-secondary);
        min-width: 120px;
      }
    }
  }
}

.slide-down-enter-active, .slide-down-leave-active {
  transition: all 0.3s ease;
}
.slide-down-enter-from, .slide-down-leave-to {
  opacity: 0;
  max-height: 0;
  padding: 0;
}
```
  </action>
  <verify>
- Clicking a ride bar shows expanded detail panel
- Clicking same bar again collapses detail
- Detail shows ride metrics (degree, duration, time window)
- Detail shows per-request mini-Gantt if request data available
- Close button dismisses detail panel
- Panel animates smoothly on expand/collapse
  </verify>
  <done>
Timeline has expandable ride detail view with per-request information
  </done>
</task>

</tasks>

<verification>
1. Zoom +/- buttons work correctly
2. Reset zoom returns to full 24-hour view
3. Minimap shows full timeline overview
4. Viewport indicator updates with zoom/pan
5. Clicking minimap navigates main chart
6. Clicking ride expands detail panel
7. Detail shows ride summary and request mini-Gantt
8. Animations work smoothly
9. No TypeScript errors
</verification>

<success_criteria>
- Zoom controls enable 1-hour to 24-hour range
- Minimap provides navigation context
- Expanded detail shows ride metrics
- Per-request timing visible in expanded view
- All interactions feel responsive
- Component remains performant with 1800+ rides
</success_criteria>

<output>
After completion, create `.planning/phases/04-timeline/04-04-SUMMARY.md`
</output>
