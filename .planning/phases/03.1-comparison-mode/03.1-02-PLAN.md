---
phase: 03.1-comparison-mode
plan: 02
type: execute
wave: 2
depends_on: ["03.1-01"]
files_modified:
  - src/plugins/interactive-dashboard/components/cards/HistogramCard.vue
autonomous: true

must_haves:
  truths:
    - "User sees gray baseline bars behind colored filtered bars when comparison mode active"
    - "Baseline bars are semi-transparent (0.3 opacity)"
    - "Legend shows 'Baseline' and 'Filtered' traces when comparison active"
    - "Clicking histogram bars still works for filtering"
  artifacts:
    - path: "src/plugins/interactive-dashboard/components/cards/HistogramCard.vue"
      provides: "Histogram with comparison mode overlay"
      contains: "baselineData"
  key_links:
    - from: "HistogramCard.vue"
      to: "Plotly traces"
      via: "barmode: 'overlay'"
      pattern: "barmode.*overlay"
---

<objective>
Add comparison mode to HistogramCard showing baseline bars behind filtered bars.

Purpose: Enable users to visually compare their filtered histogram against the full dataset, understanding how much their filter is selecting.

Output: Updated HistogramCard.vue with dual-trace rendering when showComparison is true
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03.1-comparison-mode/03.1-01-SUMMARY.md

# Reference implementation
@src/plugins/commuter-requests/components/stats/ActiveTimeHistogramPlotly.vue

# File to modify
@src/plugins/interactive-dashboard/components/cards/HistogramCard.vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add comparison props to HistogramCard</name>
  <files>src/plugins/interactive-dashboard/components/cards/HistogramCard.vue</files>
  <action>
Add new props to the Props interface:

```typescript
baselineData?: any[]      // All data (unfiltered) - from LinkableCardWrapper
showComparison?: boolean  // Whether comparison mode is active
```

Add defaults in withDefaults:
- baselineData: () => []
- showComparison: false
  </action>
  <verify>Read file, confirm props are added with correct types and defaults</verify>
  <done>HistogramCard accepts baselineData and showComparison props</done>
</task>

<task type="auto">
  <name>Task 2: Implement baseline histogram computation</name>
  <files>src/plugins/interactive-dashboard/components/cards/HistogramCard.vue</files>
  <action>
Add baselineHistogramData computed property:

```typescript
const baselineHistogramData = computed(() => {
  // Only compute if comparison mode is active and we have baseline data
  if (!props.showComparison || !props.baselineData || props.baselineData.length === 0) {
    return []
  }

  debugLog('[HistogramCard] Computing baseline histogram from', props.baselineData.length, 'rows')

  const values = props.baselineData.map(row => row[props.column])
  const binSize = props.binSize || 1

  // Create bins using same logic as histogramData
  const bins = new Map<number, number>()
  values.forEach(val => {
    if (val !== null && val !== undefined) {
      const bin = Math.floor(val / binSize) * binSize
      bins.set(bin, (bins.get(bin) || 0) + 1)
    }
  })

  return Array.from(bins.entries())
    .sort((a, b) => a[0] - b[0])
    .map(([bin, count]) => ({ bin, count }))
})
```
  </action>
  <verify>Read file, confirm baselineHistogramData computed property exists</verify>
  <done>Baseline histogram data computed when comparison mode active</done>
</task>

<task type="auto">
  <name>Task 3: Update renderChart for dual-trace rendering</name>
  <files>src/plugins/interactive-dashboard/components/cards/HistogramCard.vue</files>
  <action>
Modify the renderChart function to render two traces when comparison mode is active:

1. Change trace generation to build an array of traces:

```typescript
const traces: any[] = []

// Baseline trace (if comparison mode) - shown in background with low opacity
if (props.showComparison && baselineHistogramData.value.length > 0) {
  traces.push({
    x: baselineHistogramData.value.map(d => d.bin),
    y: baselineHistogramData.value.map(d => d.count),
    type: 'bar',
    name: 'Baseline (All Data)',
    marker: {
      color: 'rgba(156, 163, 175, 0.3)', // Gray with low opacity
    },
    hovertemplate: '<b>%{x}</b><br>Baseline: %{y}<extra></extra>',
  })
}

// Filtered trace - on top with full colors
traces.push({
  x: histogramData.value.map(d => d.bin),
  y: histogramData.value.map(d => d.count),
  type: 'bar',
  name: props.showComparison ? 'Filtered' : 'Count',
  marker: {
    color: histogramData.value.map(d =>
      selectedBins.value.has(d.bin) ? selectedColor : barColor
    ),
    line: {
      color: bgColor,
      width: 1,
    },
  },
  hovertemplate: '<b>%{x}</b><br>Filtered: %{y}<extra></extra>',
})
```

2. Update layout to use barmode 'overlay':
```typescript
const layout = {
  // ... existing properties ...
  barmode: 'overlay',  // Always overlay mode - baseline behind filtered
  showlegend: props.showComparison,  // Show legend only in comparison mode
  legend: {
    x: 1,
    xanchor: 'right',
    y: 1,
    font: { color: textColor, size: 10 },
  },
}
```

3. Pass traces array to Plotly.newPlot:
```typescript
Plotly.newPlot(plotContainer.value, traces, layout, { ... })
```

4. Fix click handler to work with multi-trace setup (only respond to filtered trace clicks).
  </action>
  <verify>
npm run build passes
Read the file and confirm:
- traces array is built with baseline trace first (when comparison active)
- barmode: 'overlay' is set in layout
- showlegend depends on props.showComparison
  </verify>
  <done>HistogramCard renders baseline behind filtered when comparison mode active (COMP-02)</done>
</task>

</tasks>

<verification>
1. npm run build passes without errors
2. When showComparison=true and baselineData provided:
   - Two traces render in Plotly chart
   - Baseline bars are gray with 0.3 opacity
   - Filtered bars overlay on top with normal colors
   - Legend shows "Baseline (All Data)" and "Filtered"
3. When showComparison=false, chart renders as before (single trace)
4. Click-to-filter functionality still works
</verification>

<success_criteria>
- Baseline bars visible behind filtered bars when comparison active
- Baseline uses consistent gray color (rgba 156, 163, 175)
- Legend appears only in comparison mode
- Existing filtering behavior preserved
</success_criteria>

<output>
After completion, create `.planning/phases/03.1-comparison-mode/03.1-02-SUMMARY.md`
</output>
