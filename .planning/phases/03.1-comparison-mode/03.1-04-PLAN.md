---
phase: 03.1-comparison-mode
plan: 04
type: execute
wave: 2
depends_on: ["03.1-01"]
files_modified:
  - src/plugins/interactive-dashboard/components/cards/ScatterCard.vue
  - src/plugins/interactive-dashboard/components/cards/DataTableCard.vue
autonomous: true

must_haves:
  truths:
    - "User sees gray baseline points behind colored filtered points in scatter plot"
    - "User sees 'X / Y' count format in table header showing filtered vs baseline"
    - "Baseline scatter points are semi-transparent (0.3 opacity)"
    - "All interactions (hover, click, filter) still work"
  artifacts:
    - path: "src/plugins/interactive-dashboard/components/cards/ScatterCard.vue"
      provides: "Scatter plot with baseline comparison"
      contains: "baselineData"
    - path: "src/plugins/interactive-dashboard/components/cards/DataTableCard.vue"
      provides: "Table with comparison count display"
      contains: "showComparison"
  key_links:
    - from: "ScatterCard.vue"
      to: "Plotly scatter traces"
      via: "baseline trace rendered first"
      pattern: "Baseline"
---

<objective>
Add comparison mode to ScatterCard and DataTableCard completing the comparison feature.

Purpose: Enable scatter plot baseline overlay and table count display for visual filter impact assessment.

Output:
- ScatterCard.vue with baseline points rendering
- DataTableCard.vue with "Filtered / Baseline" count display

Note: Inline table comparison count display is handled in Plan 03.1-01. This plan focuses only on the card components.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03.1-comparison-mode/03.1-01-SUMMARY.md

# Files to modify
@src/plugins/interactive-dashboard/components/cards/ScatterCard.vue
@src/plugins/interactive-dashboard/components/cards/DataTableCard.vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add comparison mode to ScatterCard</name>
  <files>src/plugins/interactive-dashboard/components/cards/ScatterCard.vue</files>
  <action>
Update ScatterCard.vue to support comparison mode:

1. Add new props:
```typescript
baselineData?: any[]      // All data (unfiltered)
showComparison?: boolean  // Whether comparison mode is active
```

Add defaults:
- baselineData: () => []
- showComparison: false

2. Add baselineScatterData computed property:
```typescript
const baselineScatterData = computed(() => {
  if (!props.showComparison || !props.baselineData || props.baselineData.length === 0) {
    return { x: [], y: [], ids: [], text: [] }
  }

  debugLog('[ScatterCard] Computing baseline scatter from', props.baselineData.length, 'rows')

  const x: number[] = []
  const y: number[] = []
  const ids: any[] = []
  const text: string[] = []

  props.baselineData.forEach(row => {
    const xVal = row[currentXColumn.value]
    const yVal = row[currentYColumn.value]

    if (xVal !== null && xVal !== undefined && yVal !== null && yVal !== undefined) {
      x.push(xVal)
      y.push(yVal)
      const id = props.idColumn ? row[props.idColumn] : null
      ids.push(id)

      const xFormatted = formatValue(xVal, currentXColumn.value)
      const yFormatted = formatValue(yVal, currentYColumn.value)
      text.push(`${currentXColumn.value}: ${xFormatted}<br>${currentYColumn.value}: ${yFormatted}`)
    }
  })

  return { x, y, ids, text }
})
```

3. Update renderChart to add baseline trace FIRST (rendered behind):
```typescript
// Inside renderChart, before the main traces:

// Baseline trace (if comparison mode) - gray points behind
if (props.showComparison && baselineScatterData.value.x.length > 0) {
  traces.unshift({  // unshift to add at beginning
    x: baselineScatterData.value.x,
    y: baselineScatterData.value.y,
    mode: 'markers',
    type: 'scatter',
    name: 'Baseline (All Data)',
    text: baselineScatterData.value.text,
    hoverinfo: 'text',
    marker: {
      color: 'rgba(156, 163, 175, 0.3)', // Gray with 30% opacity
      size: props.markerSize * 0.8,      // Slightly smaller
      line: {
        color: 'rgba(156, 163, 175, 0.5)',
        width: 0.5,
      },
    },
    showlegend: true,
  })
}
```

4. Update layout to show legend in comparison mode:
```typescript
showlegend: hasCategories || props.showComparison,
```

5. Update click handler to only respond to non-baseline trace clicks (check curveNumber).
  </action>
  <verify>
npm run build passes
Read the file and confirm:
- baselineData and showComparison props exist
- baselineScatterData computed property exists
- Baseline trace is added via unshift (renders first/behind)
- Baseline uses gray color with 0.3 opacity
  </verify>
  <done>ScatterCard renders baseline points behind filtered points (COMP-04)</done>
</task>

<task type="auto">
  <name>Task 2: Add comparison count display to DataTableCard</name>
  <files>src/plugins/interactive-dashboard/components/cards/DataTableCard.vue</files>
  <action>
Update DataTableCard.vue to show "Filtered / Baseline" count:

1. Add new props:
```typescript
baselineData?: any[]      // All data (unfiltered)
showComparison?: boolean  // Whether comparison mode is active
```

Add defaults:
- baselineData: () => []
- showComparison: false

2. Add computed property for comparison count text:
```typescript
const comparisonCountText = computed(() => {
  if (!props.showComparison) return ''
  const filteredCount = props.filteredData?.length || 0
  const baselineCount = props.baselineData?.length || 0
  return `${filteredCount} / ${baselineCount}`
})
```

3. Update template to show count in table-controls div:
```html
<!-- In .table-controls, after scroll-toggle and before reset button -->
<span
  v-if="showComparison && comparisonCountText"
  class="comparison-count"
  title="Filtered rows / Total rows"
>
  {{ comparisonCountText }}
</span>
```

4. Add CSS for comparison-count:
```css
.comparison-count {
  font-size: 0.75rem;
  font-weight: 600;
  color: var(--dashboard-interaction-selected, #3b82f6);
  padding: 0 0.5rem;
  border-left: 1px solid var(--dashboard-border-subtle, var(--borderFaint));
  margin-left: auto;  /* Push to right side */
}
```
  </action>
  <verify>
npm run build passes
Read the file and confirm:
- baselineData and showComparison props exist
- comparisonCountText computed property exists
- Template shows comparison count span
- CSS styles the count appropriately
  </verify>
  <done>DataTableCard shows "Filtered / Baseline" count when comparison active (COMP-05)</done>
</task>

</tasks>

<verification>
1. npm run build passes without errors
2. ScatterCard:
   - Gray baseline points render behind colored filtered points
   - Baseline points have 0.3 opacity
   - Legend shows "Baseline (All Data)" in comparison mode
   - Click interactions work on filtered points only
3. DataTableCard:
   - Shows "X / Y" format (e.g., "15 / 48") when comparison active
   - Count updates when filters change
   - Styled in blue (selected color)
4. All cards work correctly when comparison mode is OFF (no regression)
</verification>

<success_criteria>
- ScatterCard shows baseline behind filtered (COMP-04)
- DataTableCard shows "Filtered / Baseline" count (COMP-05)
- All existing functionality preserved
- Visual consistency across all comparison displays
</success_criteria>

<output>
After completion, create `.planning/phases/03.1-comparison-mode/03.1-04-SUMMARY.md`
</output>
