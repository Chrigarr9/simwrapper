---
phase: 03.1-comparison-mode
plan: 03
type: execute
wave: 2
depends_on: ["03.1-01"]
files_modified:
  - src/plugins/interactive-dashboard/components/cards/PieChartCard.vue
autonomous: true

must_haves:
  truths:
    - "User sees inner donut (filtered data) surrounded by outer ring (baseline) when comparison active"
    - "Outer baseline ring is semi-transparent (50% alpha)"
    - "Inner filtered donut uses full category colors"
    - "Click-to-filter still works on the inner donut"
  artifacts:
    - path: "src/plugins/interactive-dashboard/components/cards/PieChartCard.vue"
      provides: "Pie chart with concentric comparison mode"
      contains: "baselineData"
  key_links:
    - from: "PieChartCard.vue"
      to: "Plotly pie traces"
      via: "domain property for concentric rings"
      pattern: "hole.*0\\.7"
---

<objective>
Add comparison mode to PieChartCard showing baseline as outer ring around filtered inner ring.

Purpose: Enable users to visually compare their filtered pie chart distribution against the full dataset distribution using a concentric donut pattern.

Output: Updated PieChartCard.vue with concentric donut rendering when showComparison is true
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03.1-comparison-mode/03.1-01-SUMMARY.md

# Reference implementation
@src/plugins/commuter-requests/components/stats/MainModePieChartPlotly.vue

# File to modify
@src/plugins/interactive-dashboard/components/cards/PieChartCard.vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add comparison props to PieChartCard</name>
  <files>src/plugins/interactive-dashboard/components/cards/PieChartCard.vue</files>
  <action>
Add new props to the Props interface:

```typescript
baselineData?: any[]      // All data (unfiltered) - from LinkableCardWrapper
showComparison?: boolean  // Whether comparison mode is active
```

Add defaults in withDefaults:
- baselineData: () => []
- showComparison: false
  </action>
  <verify>Read file, confirm props are added with correct types and defaults</verify>
  <done>PieChartCard accepts baselineData and showComparison props</done>
</task>

<task type="auto">
  <name>Task 2: Implement baseline pie data computation</name>
  <files>src/plugins/interactive-dashboard/components/cards/PieChartCard.vue</files>
  <action>
Add baselinePieData computed property:

```typescript
const baselinePieData = computed(() => {
  // Only compute if comparison mode is active and we have baseline data
  if (!props.showComparison || !props.baselineData || props.baselineData.length === 0) {
    debugLog('[PieChartCard] No baseline data for comparison')
    return []
  }

  debugLog('[PieChartCard] Computing baseline pie from', props.baselineData.length, 'rows')

  const counts = new Map<string, number>()
  props.baselineData.forEach(row => {
    const val = row[props.column]
    if (val !== null && val !== undefined) {
      counts.set(String(val), (counts.get(String(val)) || 0) + 1)
    }
  })

  // Sort by count descending (same as pieData)
  const sorted = Array.from(counts.entries()).sort((a, b) => b[1] - a[1])

  return sorted.map(([label, value]) => ({ label, value }))
})
```
  </action>
  <verify>Read file, confirm baselinePieData computed property exists</verify>
  <done>Baseline pie data computed when comparison mode active</done>
</task>

<task type="auto">
  <name>Task 3: Update renderChart for concentric donut rendering</name>
  <files>src/plugins/interactive-dashboard/components/cards/PieChartCard.vue</files>
  <action>
Modify the renderChart function to render two pie traces as concentric rings when comparison mode is active:

1. Change trace generation to build an array of traces:

```typescript
const traces: any[] = []

// Main pie chart (inner ring when comparison active)
const mainTrace = {
  labels: pieData.value.map(d => d.label),
  values: pieData.value.map(d => d.value),
  type: 'pie',
  marker: {
    colors,
    line: {
      color: pieData.value.map(d =>
        selectedCategories.value.has(d.label) ? '#ffffff' : lineColor
      ),
      width: pieData.value.map(d =>
        selectedCategories.value.has(d.label) ? 3 : 1
      ),
    },
  },
  textinfo: 'percent+label',
  textfont: { color: textColor, size: 11 },
  outsidetextfont: { color: textColor, size: 11 },
  hovertemplate: '%{label}: %{value} (%{percent})<extra></extra>',
  hole: props.showComparison ? 0.4 : 0.3,  // Smaller hole for inner ring
  // Constrain to inner area when comparison active
  domain: props.showComparison ? { x: [0.15, 0.85], y: [0.15, 0.85] } : undefined,
}
traces.push(mainTrace)

// Baseline ring (if comparison mode) - outer ring with transparency
if (props.showComparison && baselinePieData.value.length > 0) {
  // Use same color map but with transparency
  const baselineColors = baselinePieData.value.map(d => {
    const baseColor = colorMap.value.get(d.label) || getCategoryColor(d.label)
    return baseColor + '80' // Add 50% alpha (hex 80 = 128/255)
  })

  traces.push({
    labels: baselinePieData.value.map(d => d.label),
    values: baselinePieData.value.map(d => d.value),
    type: 'pie',
    marker: {
      colors: baselineColors,
    },
    textinfo: 'none', // No text on baseline ring
    hovertemplate: '<b>Baseline: %{label}</b><br>%{value} (%{percent})<extra></extra>',
    hole: 0.7, // Large hole for outer ring
    domain: { x: [0, 1], y: [0, 1] }, // Full area
  })
}
```

2. Update the central annotation to show filtered count:
```typescript
annotations: [
  {
    text: props.showComparison
      ? `<b>${props.filteredData?.length || 0}</b><br><span style="font-size:9px">of ${props.baselineData?.length || 0}</span>`
      : `<b>${pieData.value.reduce((sum, d) => sum + d.value, 0)}</b>`,
    x: 0.5,
    y: 0.5,
    xref: 'paper',
    yref: 'paper',
    showarrow: false,
    font: { size: 14, color: textColor },
  },
],
```

3. Update click handler to only respond to main pie trace (trace index 0).
  </action>
  <verify>
npm run build passes
Read the file and confirm:
- traces array is built with main trace first, baseline trace second
- Main trace has hole: 0.4 and constrained domain when comparison active
- Baseline trace has hole: 0.7 and full domain
- Baseline colors have alpha suffix ('80')
  </verify>
  <done>PieChartCard renders concentric rings when comparison mode active (COMP-03)</done>
</task>

</tasks>

<verification>
1. npm run build passes without errors
2. When showComparison=true and baselineData provided:
   - Inner donut shows filtered data with full colors
   - Outer ring shows baseline data with 50% transparency
   - Categories use consistent colors between inner and outer
   - Center annotation shows "X of Y" format
3. When showComparison=false, chart renders as before (single donut)
4. Click-to-filter functionality still works on inner pie
</verification>

<success_criteria>
- Concentric donut pattern: inner (filtered) surrounded by outer (baseline)
- Baseline ring has 50% transparency
- Colors are consistent between inner and outer for same categories
- Center annotation shows filtered count "of" total in comparison mode
</success_criteria>

<output>
After completion, create `.planning/phases/03.1-comparison-mode/03.1-03-SUMMARY.md`
</output>
