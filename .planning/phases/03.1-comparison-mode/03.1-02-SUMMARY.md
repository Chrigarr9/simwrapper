---
phase: 03.1-comparison-mode
plan: 02
subsystem: interactive-charts
tags: [histogram, plotly, comparison-mode, dual-trace, overlay]

# Dependency graph
requires:
  - phase: 03.1-comparison-mode
    plan: 01
    provides: ComparisonToggle, baselineData, showComparison state
provides:
  - HistogramCard with comparison mode overlay rendering
  - Dual-trace Plotly chart (baseline + filtered)
  - Click-to-filter functionality preserved in comparison mode
affects: [03.1-03-pie-chart, 03.1-04-scatter-table]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Plotly overlay traces: Build traces array conditionally, baseline first (lower z-order)"
    - "barmode: 'overlay': Baseline bars render behind filtered bars"
    - "showlegend conditional: Legend visible only when comparison active"
    - "Click handler trace detection: curveNumber identifies which trace clicked, ignore baseline"

key-files:
  created: []
  modified:
    - src/plugins/interactive-dashboard/components/cards/HistogramCard.vue

key-decisions:
  - "Baseline bars use consistent gray (rgba 156, 163, 175, 0.3) per COMP-02"
  - "barmode: 'overlay' always set (even without baseline) for consistent rendering"
  - "Click handler checks curveNumber: baseline trace (0) ignored, filtered trace responds"
  - "Legend shows 'Baseline (All Data)' and 'Filtered' labels when comparison active"

patterns-established:
  - "Dual-trace Plotly pattern: Conditional array building, baseline pushed first"
  - "Interactive baseline handling: Clicks on baseline bars don't trigger filtering"

# Metrics
duration: 5min
completed: 2026-01-21
---

# Phase 3.1 Plan 02: HistogramCard Comparison Mode Summary

**Histogram charts now show gray baseline bars behind colored filtered bars when comparison mode active**

## Performance

- **Duration:** 5 min
- **Started:** 2026-01-21T20:10:25Z
- **Completed:** 2026-01-21T20:15:50Z
- **Tasks:** 3
- **Files modified:** 1

## Accomplishments

- Added baselineData and showComparison props to HistogramCard Props interface
- Implemented baselineHistogramData computed property (same binning logic as histogramData)
- Updated renderChart() for dual-trace rendering with overlay mode
- Baseline bars rendered in gray (rgba 156, 163, 175, 0.3) behind filtered bars
- Legend visibility controlled by showComparison prop
- Click handler updated to ignore baseline trace clicks

## Task Commits

Single atomic commit for all three tasks (simple prop addition + render logic update):

1. **Tasks 1-3: Add comparison mode to HistogramCard** - `c64c0b3a` (feat)
   - Props: baselineData, showComparison added with defaults
   - Computed: baselineHistogramData replicates histogramData binning
   - Render: Dual-trace array, overlay mode, legend control, click handling

## Files Created/Modified

- `src/plugins/interactive-dashboard/components/cards/HistogramCard.vue` - Added comparison mode props, baseline histogram computation, dual-trace rendering logic

## Implementation Details

### Baseline Histogram Computation

```typescript
const baselineHistogramData = computed(() => {
  if (!props.showComparison || !props.baselineData || props.baselineData.length === 0) {
    return []
  }

  const values = props.baselineData.map(row => row[props.column])
  const binSize = props.binSize || 1

  // Same binning logic as histogramData
  const bins = new Map<number, number>()
  values.forEach(val => {
    if (val !== null && val !== undefined) {
      const bin = Math.floor(val / binSize) * binSize
      bins.set(bin, (bins.get(bin) || 0) + 1)
    }
  })

  return Array.from(bins.entries())
    .sort((a, b) => a[0] - b[0])
    .map(([bin, count]) => ({ bin, count }))
})
```

**Key aspects:**
- Only computed when showComparison is true and baselineData exists
- Uses identical binning logic to histogramData (ensures alignment)
- Filters null/undefined values consistently

### Dual-Trace Rendering

```typescript
const traces: any[] = []

// Baseline trace (if comparison mode)
if (props.showComparison && baselineHistogramData.value.length > 0) {
  traces.push({
    x: baselineHistogramData.value.map(d => d.bin),
    y: baselineHistogramData.value.map(d => d.count),
    type: 'bar',
    name: 'Baseline (All Data)',
    marker: { color: 'rgba(156, 163, 175, 0.3)' },
    hovertemplate: '<b>%{x}</b><br>Baseline: %{y}<extra></extra>',
  })
}

// Filtered trace (always present)
traces.push({
  x: histogramData.value.map(d => d.bin),
  y: histogramData.value.map(d => d.count),
  type: 'bar',
  name: props.showComparison ? 'Filtered' : 'Count',
  marker: {
    color: histogramData.value.map(d =>
      selectedBins.value.has(d.bin) ? selectedColor : barColor
    ),
    line: { color: bgColor, width: 1 },
  },
  hovertemplate: '<b>%{x}</b><br>Filtered: %{y}<extra></extra>',
})
```

**Key aspects:**
- Baseline pushed to array first (lower z-order, renders behind)
- Filtered trace name changes based on comparison mode ('Filtered' vs 'Count')
- Baseline uses consistent gray color per COMP-02 requirement
- Both traces have clear hover labels

### Layout Configuration

```typescript
const layout = {
  // ... existing config ...
  barmode: 'overlay',  // Always overlay mode
  showlegend: props.showComparison,  // Legend only in comparison
  legend: {
    x: 1,
    xanchor: 'right',
    y: 1,
    font: { color: textColor, size: 10 },
  },
}
```

### Click Handler Protection

```typescript
plotContainer.value.on('plotly_click', (data: any) => {
  const clickedTraceIndex = data.points[0].curveNumber
  const isBaselineTrace = props.showComparison && clickedTraceIndex === 0

  if (isBaselineTrace) {
    return  // Don't respond to baseline clicks
  }

  const bin = data.points[0].x
  // ... rest of click handling ...
})
```

**Key aspects:**
- curveNumber 0 = baseline (when comparison active), 1 = filtered
- curveNumber 0 = filtered (when comparison inactive)
- Baseline clicks ignored to prevent unintended filtering

## Decisions Made

1. **Baseline color: rgba(156, 163, 175, 0.3)**: Consistent with reference implementation (ActiveTimeHistogramPlotly.vue) and COMP-02 requirement. Gray with 30% opacity provides clear visual hierarchy.

2. **barmode: 'overlay' always set**: Even when baseline not present, overlay mode is used. This ensures consistent bar width regardless of comparison mode state.

3. **Legend visibility tied to showComparison**: Legend only appears when comparison active. When inactive, single trace doesn't need legend.

4. **Click handler uses curveNumber**: Plotly provides curveNumber to identify which trace was clicked. In comparison mode, index 0 = baseline (ignore), index 1 = filtered (respond).

5. **Hover templates explicitly label traces**: "Baseline: %{y}" vs "Filtered: %{y}" removes ambiguity when hovering over overlapping bars.

## Deviations from Plan

None - plan executed exactly as written.

## Verification Results

✅ All success criteria met:

1. ✅ baselineData and showComparison props added to HistogramCard Props interface
2. ✅ baselineHistogramData computed property implemented with same binning logic
3. ✅ renderChart() builds traces array conditionally
4. ✅ Baseline bars use rgba(156, 163, 175, 0.3) gray color
5. ✅ barmode: 'overlay' configured in layout
6. ✅ showlegend controlled by props.showComparison
7. ✅ Click handler ignores baseline trace clicks via curveNumber check
8. ✅ Plotly.newPlot receives traces array (not single trace)

**Visual behavior:**
- When showComparison=false: Single filtered trace, no legend, no baseline
- When showComparison=true: Gray baseline bars behind colored filtered bars, legend visible
- Click-to-filter works on filtered bars only, baseline bars non-interactive

## Next Phase Readiness

**Ready for Plan 03 (PieChartCard concentric rings):**
- HistogramCard comparison mode complete and committed
- Pattern established for dual-trace rendering
- baselineData/showComparison props flow from foundation (Plan 01)

**Ready for Plan 04 (ScatterCard overlay + DataTableCard count):**
- HistogramCard serves as reference for comparison rendering

**Blockers:** None

**Notes:**
- HistogramCard now fully implements COMP-02 requirement
- User can toggle comparison mode via ComparisonToggle (from Plan 01)
- effectiveShowComparison ensures comparison only active when filters applied

## Lessons Learned

1. **Plotly trace ordering matters**: First trace in array renders behind subsequent traces. Baseline must be pushed first for correct z-order.

2. **curveNumber for click handling**: In multi-trace mode, data.points[0].curveNumber identifies which trace was clicked. Essential for ignoring baseline clicks.

3. **Conditional trace array building**: Building traces array with push() allows clean conditional logic. Alternative (always two traces, conditional empty data) would be messier.

4. **barmode: 'overlay' consistency**: Setting overlay mode unconditionally simplifies rendering logic - no need to toggle between 'group' and 'overlay'.

5. **Legend position matters**: Using x=1, xanchor='right' positions legend inside plot area at top-right, avoiding overlap with y-axis.

## Files Modified

### Modified
- `src/plugins/interactive-dashboard/components/cards/HistogramCard.vue` (+73 lines, -5 lines)
  - Props interface: Added baselineData and showComparison
  - Computed: Added baselineHistogramData
  - renderChart: Converted to dual-trace rendering with overlay mode
  - Click handler: Added curveNumber check to ignore baseline clicks

## Artifacts

### Pattern for Other Cards

This implementation establishes the pattern for comparison mode in Plotly charts:

1. **Props**: Accept baselineData and showComparison
2. **Computed**: Create baseline version of chart data
3. **Traces**: Build array conditionally, baseline first
4. **Layout**: barmode: 'overlay', showlegend: comparison flag
5. **Interaction**: Check curveNumber to ignore baseline

PieChartCard (Plan 03) will follow similar pattern (concentric rings instead of overlay bars).

---
*Phase: 03.1-comparison-mode*
*Completed: 2026-01-21*
