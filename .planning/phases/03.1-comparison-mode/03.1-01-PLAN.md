---
phase: 03.1-comparison-mode
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/plugins/interactive-dashboard/components/controls/ComparisonToggle.vue
  - src/plugins/interactive-dashboard/components/cards/LinkableCardWrapper.vue
  - src/plugins/interactive-dashboard/InteractiveDashboard.vue
autonomous: true

must_haves:
  truths:
    - "User sees a comparison toggle button in the dashboard header area"
    - "Toggle is disabled (visually or functionally) when no filters are active"
    - "Enabling comparison mode allows cards to show baseline vs filtered data"
  artifacts:
    - path: "src/plugins/interactive-dashboard/components/controls/ComparisonToggle.vue"
      provides: "Toggle UI component"
      min_lines: 60
    - path: "src/plugins/interactive-dashboard/components/cards/LinkableCardWrapper.vue"
      provides: "baselineData and showComparison props passed to slot"
      contains: "baselineData"
  key_links:
    - from: "InteractiveDashboard.vue"
      to: "ComparisonToggle.vue"
      via: "v-model binding for showComparison state"
      pattern: "showComparison"
    - from: "LinkableCardWrapper.vue"
      to: "child cards via slot"
      via: "baselineData slot prop"
      pattern: "baseline-data"
---

<objective>
Implement comparison mode state management and toggle UI for the interactive dashboard.

Purpose: Enable users to toggle comparison mode dashboard-wide, which will show baseline data overlaid against filtered data in all visualization cards.

Output:
- ComparisonToggle.vue component (adapted from commuter-requests plugin)
- InteractiveDashboard state management for showComparison
- LinkableCardWrapper passing baselineData to child cards
- Inline table comparison count display

**Scope clarification - cards included:**
- HistogramCard (Plan 02) - overlay bars
- PieChartCard (Plan 03) - concentric rings
- ScatterCard (Plan 04) - overlay points
- DataTableCard (Plan 04) - count display
- Inline table (this plan) - count display

**Cards excluded from comparison mode:**
- CorrelationMatrixCard: Shows attribute relationships (Pearson coefficients), not aggregate counts. Comparison mode for matrices would require side-by-side matrices or difference matrices, which is a different UX pattern. Deferred to future enhancement.
- MapCard: Shows individual geographic features, not aggregate visualizations. Comparison would require side-by-side maps (Phase 4: Dual Maps) or feature-level before/after coloring, which is architecturally different. Out of scope for this phase.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Reference implementation from commuter-requests plugin
@src/plugins/commuter-requests/components/controls/ComparisonToggle.vue
@src/plugins/commuter-requests/CommuterRequests.vue

# Files to modify
@src/plugins/interactive-dashboard/InteractiveDashboard.vue
@src/plugins/interactive-dashboard/components/cards/LinkableCardWrapper.vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ComparisonToggle component</name>
  <files>src/plugins/interactive-dashboard/components/controls/ComparisonToggle.vue</files>
  <action>
Create the ComparisonToggle.vue component in the controls directory (create directory if needed).

Adapt from the commuter-requests reference implementation with these modifications:
- Use Vue 3 Composition API with `<script setup>` for consistency with other interactive-dashboard components
- Accept props: modelValue (boolean), disabled (boolean for when no filters active)
- Emit: update:modelValue
- Use CSS variables from StyleManager (--dashboard-bg-*, --dashboard-interaction-selected)
- Label should read "Comparison" when off, "Comparison" when on (showing toggle state via checkbox)
- Add visual disabled state (reduced opacity, cursor: not-allowed) when disabled prop is true

Style the toggle to match the existing table controls aesthetic (compact, fits in header area).
  </action>
  <verify>
File exists at src/plugins/interactive-dashboard/components/controls/ComparisonToggle.vue
Component exports properly with defineComponent or script setup
  </verify>
  <done>ComparisonToggle component created with v-model support and disabled state</done>
</task>

<task type="auto">
  <name>Task 2: Update LinkableCardWrapper to pass baselineData</name>
  <files>src/plugins/interactive-dashboard/components/cards/LinkableCardWrapper.vue</files>
  <action>
Modify LinkableCardWrapper.vue to pass baselineData and showComparison to child cards via slot:

1. Add new props:
   - showComparison: boolean (default false)

2. Add computed baselineData:
   - Returns all data from dataTableManager.getData() (unfiltered)
   - If no dataTableManager, returns empty array

3. Update slot to expose additional props:
   - :baseline-data="baselineData"
   - :show-comparison="showComparison"

The slot now provides: filteredData, baselineData, showComparison, hoveredIds, selectedIds, handleFilter, handleHover, handleSelect

Note: Child cards receive these props automatically through Vue's scoped slot mechanism. No changes needed to the InteractiveDashboard template's slot bindings - LinkableCardWrapper handles the prop propagation internally.
  </action>
  <verify>
Read the file and confirm:
- showComparison prop is defined
- baselineData computed property exists
- Slot exposes baseline-data and show-comparison
  </verify>
  <done>LinkableCardWrapper passes baselineData and showComparison to child cards</done>
</task>

<task type="auto">
  <name>Task 3: Integrate comparison mode into InteractiveDashboard</name>
  <files>src/plugins/interactive-dashboard/InteractiveDashboard.vue</files>
  <action>
Update InteractiveDashboard.vue to manage comparison state:

1. Import ComparisonToggle component and add to components object

2. Add data properties:
   - showComparison: false (toggle state)

3. Add computed property:
   - hasActiveFilters: returns filterManager.hasActiveFilters()
   - effectiveShowComparison: returns showComparison && hasActiveFilters (COMP-06)

4. Add ComparisonToggle to the template:
   - Place in the table-controls div (near the scroll toggle and reset button)
   - Only show when yaml.table exists (comparison needs centralized data)
   - v-model="showComparison"
   - :disabled="!hasActiveFilters"

5. Pass showComparison to LinkableCardWrapper:
   - Add :show-comparison="effectiveShowComparison" prop to the LinkableCardWrapper component binding

Note: The slot props (baseline-data, show-comparison) are exposed by LinkableCardWrapper internally via its scoped slot. The InteractiveDashboard template does NOT need to add these to the slot template bindings - LinkableCardWrapper handles this automatically.

6. Add comparison count display to the inline table's .table-controls section:
```pug
.table-controls
  label.scroll-toggle(title="Auto-scroll to hovered row")
    input(type="checkbox" v-model="enableScrollOnHover")
    span.scroll-label Scroll

  //- Comparison count display
  span.comparison-count(
    v-if="effectiveShowComparison"
    title="Filtered rows / Total rows"
  ) {{ filteredRowIds.size }} / {{ displayData.length }}

  button.button.is-small.is-white(...)
    //- existing reset button
```

7. Add CSS for .comparison-count in the style section:
```scss
.comparison-count {
  font-size: 0.75rem;
  font-weight: 600;
  color: var(--dashboard-interaction-selected, #3b82f6);
  padding: 0 0.5rem;
  border-left: 1px solid var(--dashboard-border-subtle, var(--borderFaint));
  margin-left: auto;
}
```

These props will be available to child cards but won't be used until Plans 02-04 update the cards.
  </action>
  <verify>
Build passes: npm run build (no TypeScript errors)
Read the file and confirm:
- ComparisonToggle is imported and registered
- showComparison data property exists
- effectiveShowComparison computed property exists
- ComparisonToggle renders in template with v-model and :disabled
- LinkableCardWrapper receives :show-comparison prop
- Inline table controls show comparison count
- CSS for comparison-count is added
  </verify>
  <done>InteractiveDashboard manages comparison state, passes it to cards, and shows inline table count</done>
</task>

</tasks>

<verification>
1. npm run build passes without TypeScript errors
2. ComparisonToggle component renders in dashboard when table config exists
3. Toggle is visually disabled when no filters are active
4. effectiveShowComparison is false even if showComparison is true when no filters active
5. Inline table shows "X / Y" count format when comparison active
</verification>

<success_criteria>
- ComparisonToggle component exists and renders
- Toggle state managed at dashboard level
- baselineData and showComparison flow through LinkableCardWrapper
- Toggle disabled when no active filters (COMP-06 requirement)
- Inline table comparison count implemented
</success_criteria>

<output>
After completion, create `.planning/phases/03.1-comparison-mode/03.1-01-SUMMARY.md`
</output>
