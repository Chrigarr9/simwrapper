---
phase: 03-correlation-analysis
plan: 04
type: execute
wave: 3
depends_on: ["03-01", "03-02", "03-03"]
files_modified:
  - src/dash-panels/_allPanels.ts
  - src/plugins/interactive-dashboard/InteractiveDashboard.vue
  - src/plugins/interactive-dashboard/README.md
autonomous: false

must_haves:
  truths:
    - "User can add a correlation-matrix card to a dashboard via YAML config"
    - "Clicking a matrix cell updates a linked ScatterCard's axes"
    - "Matrix recalculates when filters change"
    - "Empty attribute list shows placeholder message"
  artifacts:
    - path: "src/dash-panels/_allPanels.ts"
      provides: "Panel registry with correlation-matrix type"
      contains: "correlation-matrix"
    - path: "src/plugins/interactive-dashboard/README.md"
      provides: "Documentation for correlation-matrix card configuration"
      contains: "correlation-matrix"
  key_links:
    - from: "src/dash-panels/_allPanels.ts"
      to: "src/plugins/interactive-dashboard/components/cards/CorrelationMatrixCard.vue"
      via: "async component import"
      pattern: "'correlation-matrix'.*CorrelationMatrixCard"
---

<objective>
Register CorrelationMatrixCard in the panel system and verify full integration with ScatterCard linkage.

Purpose: Makes the correlation matrix card available for use in dashboard YAML configurations. Includes documentation and end-to-end verification that the correlation matrix links correctly with ScatterCard.

Output: Registered card type, updated documentation, verified integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-correlation-analysis/03-CONTEXT.md

# Files to modify
@src/dash-panels/_allPanels.ts
@src/plugins/interactive-dashboard/InteractiveDashboard.vue
@src/plugins/interactive-dashboard/README.md

# Reference SUMMARYs from earlier plans
@.planning/phases/03-correlation-analysis/03-01-SUMMARY.md
@.planning/phases/03-correlation-analysis/03-02-SUMMARY.md
@.planning/phases/03-correlation-analysis/03-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Register correlation-matrix card type</name>
  <files>src/dash-panels/_allPanels.ts</files>
  <action>
Add the correlation-matrix card to the panel lookup registry.

**Add to panelLookup object in _allPanels.ts:**
```typescript
export const panelLookup: { [key: string]: AsyncComponent } = {
  // ... existing entries ...
  'correlation-matrix': defineAsyncComponent(() => import('@/plugins/interactive-dashboard/components/cards/CorrelationMatrixCard.vue')),
  // ... rest of entries ...
}
```

Place the new entry alphabetically near other interactive dashboard cards (histogram, map, pie-chart, scatter-plot) for consistency.
  </action>
  <verify>
- `npm run build` succeeds
- `correlation-matrix` is a key in panelLookup
  </verify>
  <done>correlation-matrix card type registered in panel lookup</done>
</task>

<task type="auto">
  <name>Task 2: Wire CorrelationMatrixCard events in InteractiveDashboard</name>
  <files>src/plugins/interactive-dashboard/InteractiveDashboard.vue</files>
  <action>
Update InteractiveDashboard to pass the linkageManager to CorrelationMatrixCard and handle its events.

**In the template's component section, add props for correlation-matrix cards:**

The existing template already passes `:linkage-manager="linkageManager"` to all cards via LinkableCardWrapper, but CorrelationMatrixCard emits `attributePairSelected` which needs to be handled.

**Add event handler in template (inside the component binding):**
```pug
@attribute-pair-selected="handleAttributePairSelected"
```

**Add handler method:**
```typescript
handleAttributePairSelected(attrX: string, attrY: string) {
  if (this.linkageManager) {
    this.linkageManager.setSelectedAttributePair(attrX, attrY)
  }
}
```

**Verify props are passed:**
The correlation-matrix card needs these props (most already passed via component):
- `:attributes="card.attributes"` - from YAML config
- `:show-values="card.showValues"` - optional
- `:p-value-threshold="card.pValueThreshold"` - optional
- `:filtered-data="filteredData"` - from LinkableCardWrapper slot
- `:linkage="card.linkage"` - from YAML config

Add these to the component's attribute list in the template if not already present:
```pug
:attributes="card.attributes"
:show-values="card.showValues"
:p-value-threshold="card.pValueThreshold"
```
  </action>
  <verify>
- TypeScript compiles without errors
- CorrelationMatrixCard receives required props
- attributePairSelected event is handled
  </verify>
  <done>
- InteractiveDashboard passes attributes prop to CorrelationMatrixCard
- attributePairSelected event routed through linkageManager
  </done>
</task>

<task type="auto">
  <name>Task 3: Update README documentation</name>
  <files>src/plugins/interactive-dashboard/README.md</files>
  <action>
Add documentation for the correlation-matrix card type to the Interactive Dashboard README.

**Add new section after existing card documentation:**

```markdown
### Correlation Matrix Card

Displays a Pearson correlation matrix as an interactive heatmap, showing relationships between numeric attributes.

**YAML Configuration:**
```yaml
- type: correlation-matrix
  title: "Attribute Correlations"
  attributes:              # Required: list of columns to correlate
    - travel_time
    - distance
    - wait_time
    - detour_factor
  width: 2
  height: 4
  showValues: auto         # Optional: 'always', 'never', 'auto' (default: auto)
  pValueThreshold: 0.05    # Optional: significance threshold (default: 0.05)
  linkage:                 # Optional: link to ScatterCard
    type: attributePair
```

**Configuration Options:**

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `attributes` | string[] | (required) | Column names to include in correlation matrix |
| `showValues` | string | `'auto'` | When to show r values in cells: `'always'`, `'never'`, or `'auto'` (hide when >20 attributes) |
| `pValueThreshold` | number | `0.05` | Significance threshold; correlations with p < threshold marked with asterisk |
| `linkage.type` | string | - | Set to `'attributePair'` to enable clicking cells to update linked ScatterCard |

**Visual Features:**
- Blue-white-red diverging color scale (blue=negative, white=zero, red=positive)
- Asterisk (*) on significant correlations when cell values visible
- Hover tooltip shows: correlation (r), p-value, and sample size (n)
- Sample size displayed in header
- Loading indicator during calculation

**Linking to ScatterCard:**

To have clicking a correlation cell update a ScatterCard's axes:

1. Add `linkage.type: attributePair` to the correlation-matrix card
2. Add `listenToAttributePairSelection: true` to the ScatterCard

```yaml
layout:
  row1:
    - type: correlation-matrix
      attributes: [travel_time, distance, wait_time]
      linkage:
        type: attributePair

    - type: scatter-plot
      xColumn: travel_time
      yColumn: distance
      listenToAttributePairSelection: true
```

When user clicks a cell in the matrix, the ScatterCard updates to show that attribute pair.
```
  </action>
  <verify>
- README.md contains correlation-matrix documentation
- Example YAML is valid
- Linkage section explains ScatterCard integration
  </verify>
  <done>Documentation added for correlation-matrix card configuration and linkage</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete correlation analysis feature:
1. Statistics utilities for Pearson correlation with p-values
2. CorrelationMatrixCard component with interactive heatmap
3. LinkageManager extended with attribute pair events
4. ScatterCard updated with dynamic axis support
5. Card registered and documented
  </what-built>
  <how-to-verify>
**Test Setup:**
1. Create a test dashboard YAML with correlation-matrix card:
```yaml
header:
  tab: Test
  title: Correlation Test

layout:
  row1:
    - type: correlation-matrix
      title: Correlations
      attributes:
        - treq     # or any numeric columns in your data
        - direct_distance_m
        - total_distance_m
      width: 2
      height: 3
      linkage:
        type: attributePair

    - type: scatter-plot
      title: Scatter
      xColumn: treq
      yColumn: direct_distance_m
      width: 1
      height: 3
      listenToAttributePairSelection: true
```

**Verification Steps:**
1. Load the dashboard and verify heatmap renders with blue-white-red colors
2. Hover over a cell - confirm tooltip shows r, p-value, and n
3. Click a cell - confirm ScatterCard axes update to show that attribute pair
4. Apply a filter via another card (histogram) - confirm matrix recalculates (n changes)
5. Check that significant correlations (p<0.05) show asterisk when cells have text

**Expected Behavior:**
- Matrix shows symmetric correlation values
- Diagonal should be r=1.0 (correlation with self)
- Clicking total_distance_m x treq cell should update scatter to show those axes
- Sample size in header should match filtered data count
  </how-to-verify>
  <resume-signal>Type "approved" if all verification steps pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` succeeds without errors
2. `npm run dev` starts successfully
3. Test dashboard with correlation-matrix card loads and displays heatmap
4. Cell click updates linked ScatterCard axes
5. Filter changes trigger matrix recalculation
</verification>

<success_criteria>
CORR-01: User sees heatmap with Pearson correlations - cell colors indicate relationship strength
CORR-02: Attributes configured via YAML (no runtime selector per CONTEXT.md)
Phase Success Criteria 1: Heatmap shows correlation coefficients
Phase Success Criteria 2: Hover tooltip shows r, p-value, attribute names
Phase Success Criteria 3: Attributes configured in YAML (selector requirement modified per CONTEXT.md)
Phase Success Criteria 4: Filter changes cause matrix to recalculate for filtered rows
</success_criteria>

<output>
After completion, create `.planning/phases/03-correlation-analysis/03-04-SUMMARY.md`
</output>
