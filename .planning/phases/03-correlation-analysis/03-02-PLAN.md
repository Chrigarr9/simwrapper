---
phase: 03-correlation-analysis
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/plugins/interactive-dashboard/components/cards/CorrelationMatrixCard.vue
autonomous: true

must_haves:
  truths:
    - "User sees a heatmap where each cell shows correlation between two attributes"
    - "User hovers over a cell and sees tooltip with correlation value, p-value, and sample size"
    - "Significant correlations are visually distinguished from non-significant ones"
    - "Matrix recalculates when filtered data changes"
  artifacts:
    - path: "src/plugins/interactive-dashboard/components/cards/CorrelationMatrixCard.vue"
      provides: "Correlation matrix heatmap visualization"
      min_lines: 200
  key_links:
    - from: "src/plugins/interactive-dashboard/components/cards/CorrelationMatrixCard.vue"
      to: "src/plugins/interactive-dashboard/utils/statistics.ts"
      via: "import computeCorrelationMatrix"
      pattern: "import.*computeCorrelationMatrix.*statistics"
    - from: "src/plugins/interactive-dashboard/components/cards/CorrelationMatrixCard.vue"
      to: "plotly.js"
      via: "Plotly.newPlot for heatmap"
      pattern: "Plotly\\.newPlot"
---

<objective>
Create CorrelationMatrixCard Vue component that renders a Pearson correlation matrix as an interactive heatmap.

Purpose: Allows users to visualize pairwise relationships between cluster attributes. The heatmap uses diverging blue-white-red colors centered at zero, with hover tooltips showing correlation details and significance indicators.

Output: `CorrelationMatrixCard.vue` component following ScatterCard/HistogramCard patterns.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-correlation-analysis/03-RESEARCH.md

# Implementation patterns
@src/plugins/interactive-dashboard/components/cards/ScatterCard.vue
@src/plugins/interactive-dashboard/components/cards/HistogramCard.vue
@src/plugins/interactive-dashboard/managers/StyleManager.ts

# Statistics utilities (from Plan 01)
@src/plugins/interactive-dashboard/utils/statistics.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CorrelationMatrixCard component structure</name>
  <files>src/plugins/interactive-dashboard/components/cards/CorrelationMatrixCard.vue</files>
  <action>
Create `src/plugins/interactive-dashboard/components/cards/CorrelationMatrixCard.vue` following the ScatterCard pattern.

**Template (Pug):**
```pug
.correlation-matrix-card
  .header-info(v-if="showHeader")
    span.sample-size n = {{ sampleSize }}
  .loading-overlay(v-if="isCalculating")
    span Calculating...
  .plot-container(ref="plotContainer")
```

**Props interface:**
```typescript
interface Props {
  title?: string
  attributes: string[]       // Columns to include in matrix (from YAML)
  filteredData?: any[]       // From LinkableCardWrapper
  showValues?: 'always' | 'never' | 'auto'  // Cell value display mode (default: 'auto')
  pValueThreshold?: number   // Significance threshold (default: 0.05)
  linkage?: {
    type: 'attributePair'
    targetCard?: string      // ID of ScatterCard to update (optional)
  }
}
```

**Emits:**
```typescript
emit('attributePairSelected', attrX: string, attrY: string)  // Cell click
emit('isLoaded')
```

**Core reactive state:**
- `plotContainer: ref<HTMLElement>()`
- `isCalculating: ref<boolean>(false)`
- `correlationData: ref<CorrelationMatrixResult | null>(null)`
- `hoveredCell: ref<{ row: number; col: number } | null>(null)`

**Computed:**
- `sampleSize`: Minimum sample size from matrix (shows n for current filter)
- `shouldShowValues`: Based on `showValues` prop and attribute count (auto = hide if > 20)
  </action>
  <verify>
- File exists at correct path
- TypeScript interfaces are valid
- No syntax errors in template
  </verify>
  <done>Component structure created with props, emits, and reactive state</done>
</task>

<task type="auto">
  <name>Task 2: Implement correlation calculation and Plotly rendering</name>
  <files>src/plugins/interactive-dashboard/components/cards/CorrelationMatrixCard.vue</files>
  <action>
Add the main functionality to CorrelationMatrixCard:

**Import correlation utilities:**
```typescript
import { computeCorrelationMatrix, CorrelationMatrixResult } from '../../utils/statistics'
```

**calculateCorrelations() function:**
1. Set `isCalculating = true`
2. Guard: If no attributes or no data, set empty state and return
3. Call `computeCorrelationMatrix(props.filteredData, props.attributes)`
4. Store result in `correlationData`
5. Set `isCalculating = false`
6. Call `renderChart()`

**Debounce calculation:** Use 200ms debounce on filteredData changes to avoid excessive recalculation during rapid filtering.

**renderChart() function:**

1. **Theme colors from StyleManager:**
   - `bgColor = styleManager.getColor('theme.background.primary')`
   - `textColor = styleManager.getColor('theme.text.primary')`

2. **Plotly heatmap trace:**
```typescript
const trace = {
  z: correlationData.value.matrix,
  x: props.attributes,
  y: props.attributes,
  type: 'heatmap',
  colorscale: [
    [0.0, '#3b4cc0'],  // Blue for -1 (negative)
    [0.5, '#f7f7f7'],  // White for 0
    [1.0, '#b40426']   // Red for +1 (positive)
  ],
  zmid: 0,
  zmin: -1,
  zmax: 1,
  hovertemplate: buildHoverTemplate(),
  customdata: buildCustomData(),  // p-values and n for hover
  showscale: true,
  colorbar: {
    title: { text: 'r', font: { color: textColor } },
    tickfont: { color: textColor },
  }
}
```

3. **Annotations (conditional cell text):**
   - If `shouldShowValues`, add text annotations for each cell
   - Format: `r.toFixed(2)` with asterisk (*) for significant correlations
   - Use white text on dark cells (|r| > 0.5), black on light cells

4. **Layout:**
```typescript
const layout = {
  xaxis: { tickfont: { color: textColor, size: 10 }, tickangle: -45 },
  yaxis: { tickfont: { color: textColor, size: 10 } },
  margin: { l: 100, r: 50, t: 20, b: 100 },
  paper_bgcolor: bgColor,
  plot_bgcolor: bgColor,
  annotations: shouldShowValues ? annotations : [],
}
```

5. **Event handlers:**
   - `plotly_click`: Emit `attributePairSelected` with the two attribute names
   - `plotly_hover`: Update `hoveredCell` for row/column highlight (optional enhancement)
   - `plotly_unhover`: Clear `hoveredCell`

**Watch handlers:**
- `watch(() => props.filteredData, debouncedCalculate, { deep: true })`
- `watch(isDarkMode, renderChart)` for theme changes
  </action>
  <verify>
- Import from statistics.ts works
- Plotly renders heatmap without errors
- Cell click emits event with attribute names
  </verify>
  <done>
- Correlation matrix calculates from filtered data
- Plotly heatmap renders with diverging blue-white-red scale
- Cell click emits attributePairSelected event
- Hover shows correlation value, p-value, and sample size
  </done>
</task>

<task type="auto">
  <name>Task 3: Add styles and resize handling</name>
  <files>src/plugins/interactive-dashboard/components/cards/CorrelationMatrixCard.vue</files>
  <action>
Complete the component with styles and resize handling:

**Resize handling (copy from ScatterCard pattern):**
```typescript
let resizeObserver: ResizeObserver | null = null
let resizeTimeout: ReturnType<typeof setTimeout> | null = null

function handleResize() {
  if (resizeTimeout) clearTimeout(resizeTimeout)
  resizeTimeout = setTimeout(() => {
    if (plotContainer.value) {
      Plotly.Plots.resize(plotContainer.value)
    }
    resizeTimeout = null
  }, 100)
}

onMounted(() => {
  calculateCorrelations()

  if (plotContainer.value) {
    resizeObserver = new ResizeObserver(() => nextTick(() => handleResize()))
    resizeObserver.observe(plotContainer.value)
  }

  window.addEventListener('resize', handleResize)
  emit('isLoaded')
})

onUnmounted(() => {
  if (resizeObserver) {
    resizeObserver.disconnect()
    resizeObserver = null
  }
  if (resizeTimeout) clearTimeout(resizeTimeout)
  window.removeEventListener('resize', handleResize)
})
```

**Scoped CSS:**
```css
.correlation-matrix-card {
  height: 100%;
  display: flex;
  flex-direction: column;
  background-color: var(--dashboard-bg-secondary, var(--bgCardFrame));
  position: relative;
}

.header-info {
  padding: 4px 8px;
  font-size: 11px;
  color: var(--dashboard-text-secondary, var(--text));
  text-align: right;
}

.sample-size {
  font-family: monospace;
}

.loading-overlay {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: var(--dashboard-bg-primary, var(--bgPanel));
  padding: 8px 16px;
  border-radius: 4px;
  z-index: 10;
  font-size: 12px;
}

.plot-container {
  flex: 1;
  min-height: 0;
}
```
  </action>
  <verify>
- Component resizes properly when container changes
- Loading overlay appears during calculation
- Sample size displays in header
- Styles match other card components
  </verify>
  <done>
- ResizeObserver and window resize handlers implemented
- Loading state shows during calculation
- Scoped CSS follows project conventions
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Component file exists and compiles without TypeScript errors
2. `npm run build` succeeds
3. Manual test: Add a correlation-matrix card to a test dashboard YAML and verify heatmap renders
</verification>

<success_criteria>
1. Heatmap displays with correlation values colored blue-white-red
2. Hover tooltip shows exact r value, p-value, and sample size
3. Significant correlations (p < 0.05) marked with asterisk when cell text visible
4. Matrix recalculates when filtered data changes (with debounce)
5. Cell click emits attributePairSelected event with both attribute names
6. Component follows ScatterCard/HistogramCard patterns for theme and resize
</success_criteria>

<output>
After completion, create `.planning/phases/03-correlation-analysis/03-02-SUMMARY.md`
</output>
