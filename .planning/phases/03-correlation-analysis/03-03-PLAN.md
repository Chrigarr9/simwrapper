---
phase: 03-correlation-analysis
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/plugins/interactive-dashboard/managers/LinkageManager.ts
  - src/plugins/interactive-dashboard/components/cards/ScatterCard.vue
autonomous: true

must_haves:
  truths:
    - "LinkageManager can broadcast attribute pair selection events"
    - "ScatterCard can listen for attribute pair events and update axes"
    - "Existing hover/select functionality remains unchanged"
  artifacts:
    - path: "src/plugins/interactive-dashboard/managers/LinkageManager.ts"
      provides: "Extended observer pattern with attribute pair events"
      exports: ["LinkageObserver", "LinkageManager"]
      contains: "onAttributePairSelected"
    - path: "src/plugins/interactive-dashboard/components/cards/ScatterCard.vue"
      provides: "ScatterCard with dynamic axis updates from correlation matrix"
      contains: "onAttributePairSelected"
  key_links:
    - from: "src/plugins/interactive-dashboard/components/cards/ScatterCard.vue"
      to: "src/plugins/interactive-dashboard/managers/LinkageManager.ts"
      via: "observer registration for attribute pair events"
      pattern: "onAttributePairSelected.*attrX.*attrY"
---

<objective>
Extend LinkageManager with attribute pair selection events and update ScatterCard to listen for axis changes.

Purpose: Enables the correlation matrix to communicate with ScatterCard - clicking a cell in the matrix updates the scatter plot axes to show that attribute pair. This creates a powerful exploration flow: see correlation in matrix, click to examine relationship in scatter plot.

Output: Updated LinkageManager with new event type, ScatterCard with dynamic axis support.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-correlation-analysis/03-RESEARCH.md

# Files to modify
@src/plugins/interactive-dashboard/managers/LinkageManager.ts
@src/plugins/interactive-dashboard/components/cards/ScatterCard.vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend LinkageManager with attribute pair events</name>
  <files>src/plugins/interactive-dashboard/managers/LinkageManager.ts</files>
  <action>
Extend the existing LinkageManager to support attribute pair selection events:

**Update LinkageObserver interface:**
```typescript
export interface LinkageObserver {
  onHoveredIdsChange: (ids: Set<any>) => void
  onSelectedIdsChange: (ids: Set<any>) => void
  // NEW: Optional handler for attribute pair selection (from correlation matrix)
  onAttributePairSelected?: (attrX: string, attrY: string) => void
}
```

**Add state and methods to LinkageManager class:**
```typescript
export class LinkageManager {
  private hoveredIds: Set<any> = new Set()
  private selectedIds: Set<any> = new Set()
  private observers: Set<LinkageObserver> = new Set()

  // NEW: Track selected attribute pair
  private selectedAttributePair: { x: string; y: string } | null = null

  // ... existing methods unchanged ...

  // NEW: Set selected attribute pair (called by CorrelationMatrixCard)
  setSelectedAttributePair(attrX: string, attrY: string): void {
    this.selectedAttributePair = { x: attrX, y: attrY }
    this.notifyAttributePairSelection()
  }

  // NEW: Get current attribute pair (for components that need to check state)
  getSelectedAttributePair(): { x: string; y: string } | null {
    return this.selectedAttributePair
  }

  // NEW: Clear attribute pair selection
  clearAttributePairSelection(): void {
    this.selectedAttributePair = null
    // Optionally notify observers of clear (not strictly necessary)
  }

  // NEW: Notification method for attribute pair
  private notifyAttributePairSelection(): void {
    if (!this.selectedAttributePair) return

    this.observers.forEach(obs => {
      if (obs.onAttributePairSelected) {
        obs.onAttributePairSelected(
          this.selectedAttributePair!.x,
          this.selectedAttributePair!.y
        )
      }
    })
  }
}
```

**Important:** Keep all existing methods exactly as they are. Only ADD new state and methods for attribute pair functionality.
  </action>
  <verify>
- TypeScript compiles without errors
- Existing hover/select tests still pass (if any)
- New methods are callable
  </verify>
  <done>
- LinkageObserver interface extended with optional onAttributePairSelected
- LinkageManager has setSelectedAttributePair, getSelectedAttributePair methods
- Notification broadcasts to all observers with the method
  </done>
</task>

<task type="auto">
  <name>Task 2: Update ScatterCard to support dynamic axis updates</name>
  <files>src/plugins/interactive-dashboard/components/cards/ScatterCard.vue</files>
  <action>
Update ScatterCard to optionally listen for attribute pair selection events and update its axes dynamically.

**Add new props:**
```typescript
interface Props {
  // ... existing props ...
  listenToAttributePairSelection?: boolean  // Enable dynamic axis updates
  linkageManager?: LinkageManager           // Manager instance for observing events
}

const props = withDefaults(defineProps<Props>(), {
  // ... existing defaults ...
  listenToAttributePairSelection: false,
})
```

**Add reactive state for dynamic axes:**
```typescript
// Current axis columns (can be overridden by attribute pair selection)
const currentXColumn = ref(props.xColumn)
const currentYColumn = ref(props.yColumn)

// Watch for prop changes to reset defaults
watch(() => props.xColumn, (newVal) => { currentXColumn.value = newVal })
watch(() => props.yColumn, (newVal) => { currentYColumn.value = newVal })
```

**Update scatterData computed to use currentXColumn/currentYColumn:**
Replace all uses of `props.xColumn` with `currentXColumn.value` and `props.yColumn` with `currentYColumn.value` in:
- The scatterData computed property
- The renderChart function (axis titles)
- Hover text generation

**Add LinkageObserver for attribute pair events:**
```typescript
const linkageObserver: LinkageObserver = {
  onHoveredIdsChange: () => {},      // Not used in scatter
  onSelectedIdsChange: () => {},     // Not used in scatter
  onAttributePairSelected: (attrX: string, attrY: string) => {
    if (!props.listenToAttributePairSelection) return

    // Check if attributes exist in data
    if (props.filteredData && props.filteredData.length > 0) {
      const sampleRow = props.filteredData[0]
      const hasX = attrX in sampleRow
      const hasY = attrY in sampleRow

      if (hasX && hasY) {
        currentXColumn.value = attrX
        currentYColumn.value = attrY
        // Re-render will happen via watch on currentXColumn/currentYColumn
      } else {
        console.warn(`[ScatterCard] Attributes not found in data: ${attrX}, ${attrY}`)
      }
    }
  }
}

onMounted(() => {
  // ... existing code ...

  // Register observer if listening is enabled
  if (props.listenToAttributePairSelection && props.linkageManager) {
    props.linkageManager.addObserver(linkageObserver)
  }
})

onUnmounted(() => {
  // ... existing cleanup ...

  // Unregister observer
  if (props.linkageManager) {
    props.linkageManager.removeObserver(linkageObserver)
  }
})
```

**Add watch for currentXColumn/currentYColumn:**
```typescript
watch([currentXColumn, currentYColumn], () => {
  debugLog('[ScatterCard] Axes changed to:', currentXColumn.value, currentYColumn.value)
  renderChart()
})
```

**Import LinkageObserver type:**
```typescript
import { LinkageManager, LinkageObserver } from '../../managers/LinkageManager'
```
  </action>
  <verify>
- TypeScript compiles without errors
- ScatterCard still works without listenToAttributePairSelection prop (default behavior)
- When enabled, axes update when linkageManager broadcasts attribute pair
  </verify>
  <done>
- ScatterCard accepts optional listenToAttributePairSelection prop
- When enabled and linkageManager provided, ScatterCard updates axes on attribute pair events
- Existing ScatterCard functionality unchanged when prop is false
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` succeeds
2. LinkageManager.ts has setSelectedAttributePair method
3. ScatterCard.vue has listenToAttributePairSelection prop
4. Manual test scenario:
   - Configure ScatterCard with `listenToAttributePairSelection: true`
   - Call `linkageManager.setSelectedAttributePair('attr1', 'attr2')`
   - Verify ScatterCard re-renders with new axes
</verification>

<success_criteria>
1. LinkageManager extended without breaking existing functionality
2. ScatterCard optionally listens for attribute pair events
3. Axes update dynamically when attribute pair is selected
4. Invalid attribute names handled gracefully (warning logged)
5. Component cleanup properly unregisters observer
</success_criteria>

<output>
After completion, create `.planning/phases/03-correlation-analysis/03-03-SUMMARY.md`
</output>
