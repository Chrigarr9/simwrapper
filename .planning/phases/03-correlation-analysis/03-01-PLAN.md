---
phase: 03-correlation-analysis
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/plugins/interactive-dashboard/utils/statistics.ts
  - package.json
  - package-lock.json
autonomous: true

must_haves:
  truths:
    - "Pearson correlation can be computed between any two numeric arrays"
    - "P-value indicates statistical significance of correlation"
    - "Missing/invalid values are handled gracefully without crashing"
  artifacts:
    - path: "src/plugins/interactive-dashboard/utils/statistics.ts"
      provides: "Correlation calculation utilities"
      exports: ["correlationWithPValue", "computeCorrelationMatrix", "CorrelationResult", "CorrelationMatrixResult"]
      min_lines: 80
  key_links:
    - from: "src/plugins/interactive-dashboard/utils/statistics.ts"
      to: "simple-statistics"
      via: "sampleCorrelation import"
      pattern: "import.*sampleCorrelation.*simple-statistics"
---

<objective>
Create statistics utility module with Pearson correlation calculation and p-value computation.

Purpose: Provides the mathematical foundation for the correlation matrix card. All correlation calculations are centralized in one module for testability and reuse.

Output: `src/plugins/interactive-dashboard/utils/statistics.ts` with correlation functions, plus simple-statistics dependency installed.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-correlation-analysis/03-RESEARCH.md

# Reference patterns
@src/plugins/interactive-dashboard/utils/debug.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install simple-statistics dependency</name>
  <files>package.json, package-lock.json</files>
  <action>
Install simple-statistics library for Pearson correlation calculation:

```bash
npm install simple-statistics
```

This library is lightweight (~3KB), zero dependencies, and provides numerically stable `sampleCorrelation(x, y)` function that handles edge cases properly.
  </action>
  <verify>
- `npm list simple-statistics` shows version 7.x installed
- `package.json` contains `"simple-statistics": "^7.x"`
  </verify>
  <done>simple-statistics dependency installed and listed in package.json</done>
</task>

<task type="auto">
  <name>Task 2: Create statistics utility module</name>
  <files>src/plugins/interactive-dashboard/utils/statistics.ts</files>
  <action>
Create `src/plugins/interactive-dashboard/utils/statistics.ts` with the following:

**TypeScript interfaces:**
```typescript
export interface CorrelationResult {
  r: number           // Correlation coefficient (-1 to 1)
  p: number           // Two-tailed p-value
  n: number           // Sample size (after filtering missing values)
  significant: boolean // p < alpha (default 0.05)
}

export interface CorrelationMatrixResult {
  matrix: number[][]      // Correlation coefficients
  pValues: number[][]     // P-values for each pair
  sampleSizes: number[][] // Sample size for each pair
  attributes: string[]    // Attribute names (for reference)
}
```

**Implementation requirements:**

1. **`correlationWithPValue(x: number[], y: number[], alpha?: number): CorrelationResult`**
   - Use `sampleCorrelation` from simple-statistics
   - Filter paired values where either is null/undefined/NaN
   - Return `{ r: 0, p: 1, n, significant: false }` if n < 3 (insufficient data)
   - Calculate t-statistic: `t = r * sqrt(n-2) / sqrt(1 - r*r)`
   - **Handle r near +/-1:** Clamp |r| to 0.9999 to avoid division by zero
   - Calculate two-tailed p-value using t-distribution CDF approximation
   - Default alpha = 0.05

2. **`tCDF(t: number, df: number): number`** (private helper)
   - Approximation for t-distribution CDF
   - For df >= 30, use normal approximation: `normalCDF(t)`
   - For df < 30, use more accurate approximation (Abramowitz & Stegun or simple lookup)
   - Return value in [0, 1]

3. **`computeCorrelationMatrix(data: any[], attributes: string[]): CorrelationMatrixResult`**
   - Compute full n x n correlation matrix
   - Diagonal is always r=1, p=0, n=data.length
   - For off-diagonal: call `correlationWithPValue` for each pair
   - Return structured result with all matrices and attribute names

**Important implementation notes:**
- Add JSDoc comments explaining formulas and edge cases
- Include comment about two-tailed test (not one-tailed)
- Log warning to console if matrix size > 50 attributes (performance consideration)
  </action>
  <verify>
- File exists at `src/plugins/interactive-dashboard/utils/statistics.ts`
- TypeScript compiles without errors: `npx tsc --noEmit src/plugins/interactive-dashboard/utils/statistics.ts`
- Exports are importable: Create a quick test import in a scratch file
  </verify>
  <done>
- statistics.ts exports CorrelationResult, CorrelationMatrixResult interfaces
- correlationWithPValue handles missing data, edge cases, returns p-values
- computeCorrelationMatrix produces full matrix from data array
  </done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for correlation utilities</name>
  <files>src/plugins/interactive-dashboard/utils/__tests__/statistics.test.ts</files>
  <action>
Create test file at `src/plugins/interactive-dashboard/utils/__tests__/statistics.test.ts`:

**Test cases for correlationWithPValue:**
1. Perfect positive correlation (r=1): `[1,2,3,4,5]` vs `[1,2,3,4,5]` => r approx 1
2. Perfect negative correlation (r=-1): `[1,2,3,4,5]` vs `[5,4,3,2,1]` => r approx -1
3. No correlation (r~0): `[1,2,3,4,5]` vs `[3,1,4,1,5]` => r close to 0
4. Missing values filtered: `[1,2,null,4,5]` vs `[1,2,3,4,undefined]` => n=3
5. Insufficient data: `[1,2]` vs `[1,2]` => { r: 0, p: 1, significant: false }
6. Significance detection: Strong correlation with enough samples => significant: true

**Test cases for computeCorrelationMatrix:**
1. 2x2 matrix: Two attributes, verify symmetry and diagonal=1
2. Missing values in matrix: Data with sparse values, verify sample sizes differ

Use vitest patterns from existing tests in the codebase.
  </action>
  <verify>
- `npm run test:run -- src/plugins/interactive-dashboard/utils/__tests__/statistics.test.ts` passes
- At least 6 test cases pass
  </verify>
  <done>
- Unit tests cover edge cases: perfect correlation, no correlation, missing data, insufficient samples
- All tests pass
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm list simple-statistics` confirms installation
2. `npm run test:run -- src/plugins/interactive-dashboard/utils/__tests__/statistics.test.ts` passes all tests
3. `npm run build` completes without TypeScript errors
</verification>

<success_criteria>
1. simple-statistics dependency is installed
2. statistics.ts exports correlation calculation functions
3. Pearson correlation returns correct values for known test cases
4. P-values are two-tailed and statistically valid
5. Missing data handling doesn't crash or produce NaN
6. All unit tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-correlation-analysis/03-01-SUMMARY.md`
</output>
