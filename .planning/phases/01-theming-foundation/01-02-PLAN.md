---
phase: 01-theming-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/plugins/interactive-dashboard/components/cards/MapCard.vue
  - src/plugins/interactive-dashboard/components/cards/ColorLegend.vue
  - src/plugins/interactive-dashboard/InteractiveDashboard.vue
autonomous: true

must_haves:
  truths:
    - "MapCard uses CSS variables for all theme-dependent colors"
    - "Hover state consistently shows orange across map features"
    - "Selected state consistently shows blue across map features"
    - "OD cluster colors come from StyleManager"
    - "Dashboard YAML can configure custom OD cluster colors"
  artifacts:
    - path: "src/plugins/interactive-dashboard/components/cards/MapCard.vue"
      provides: "Theme-aware map visualization"
      contains: "var(--dashboard-"
    - path: "src/plugins/interactive-dashboard/InteractiveDashboard.vue"
      provides: "YAML cluster color parsing"
      contains: "setClusterColors"
  key_links:
    - from: "MapCard.vue"
      to: "StyleManager"
      via: "getInteractionColorRGBA import"
      pattern: "getInteractionColorRGBA|getClusterColor"
    - from: "InteractiveDashboard.vue"
      to: "StyleManager.setClusterColors"
      via: "YAML config parsing"
      pattern: "setClusterColors.*config\\.colors"
---

<objective>
Migrate MapCard.vue to use centralized theme colors from StyleManager, replacing all hardcoded RGBA values for interaction states, cluster colors, and theme-dependent styling. Also implement YAML configuration for OD cluster colors.

Purpose: MapCard is the most complex component with the most hardcoded colors. Migrating it establishes the pattern for other cards. YAML configuration enables per-dashboard color customization.

Output: MapCard.vue using CSS variables and StyleManager helpers for all colors, plus YAML cluster color configuration support.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-theming-foundation/01-CONTEXT.md
@.planning/phases/01-theming-foundation/01-01-SUMMARY.md
@src/plugins/interactive-dashboard/components/cards/MapCard.vue
@src/plugins/interactive-dashboard/managers/StyleManager.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace hardcoded interaction state colors in MapCard</name>
  <files>src/plugins/interactive-dashboard/components/cards/MapCard.vue</files>
  <action>
Replace all hardcoded RGBA arrays for hover and selected states with StyleManager calls:

1. **Import helpers at top of script section**:
   ```typescript
   import { getInteractionColorRGBA, getClusterColor } from '../../utils/colorSchemes'
   ```

2. **Replace in getFeatureFillColor function** (around line 1111-1143):
   - Line ~1121: `[59, 130, 246, 120]` (selected) -> `getInteractionColorRGBA('selected', 120)`
   - Line ~1125: `[251, 146, 60, 100]` (hovered) -> `getInteractionColorRGBA('hover', 100)`
   - Line ~1133: `[180, 180, 180, 80]` (dimmed) -> keep as-is or use StyleManager dimmed color

3. **Replace in getFeatureLineColor function** (around line 1145-1165):
   - Line ~1152: `[59, 130, 246, 255]` (selected) -> `getInteractionColorRGBA('selected', 255)`
   - Line ~1156: `[251, 146, 60, 255]` (hovered) -> `getInteractionColorRGBA('hover', 255)`

4. **Replace in getFeatureColor function** (around line 1309-1341):
   - Line ~1317: `[59, 130, 246, 255]` (selected) -> `getInteractionColorRGBA('selected', 255)`
   - Line ~1320: `[251, 146, 60, 255]` (hovered) -> `getInteractionColorRGBA('hover', 255)`

5. **Replace in scatterplot line colors** (around line 959, 1064):
   - `[255, 255, 255, 200]` - keep for contrast outline

6. **Replace tooltip style colors** (getTooltipStyle function, ~line 636-652):
   - Use CSS variable references or computed from StyleManager:
   ```typescript
   const styleManager = StyleManager.getInstance();
   return {
     backgroundColor: styleManager.getColor('theme.background.secondary'),
     color: styleManager.getColor('theme.text.primary'),
     // ... rest
   }
   ```

Pattern: Search for `[59, 130, 246` (selected blue) and `[251, 146, 60` or `[251, 191, 36` (hover orange) and replace systematically.
  </action>
  <verify>
    - No remaining hardcoded `[59, 130, 246` in MapCard.vue (search confirms)
    - No remaining hardcoded `[251, 146, 60` in MapCard.vue
    - npm run dev shows map with working hover/select highlighting
  </verify>
  <done>
    - All interaction state colors use StyleManager
    - Hover state shows consistent orange across all feature types
    - Selected state shows consistent blue across all feature types
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace theme-dependent UI colors in MapCard</name>
  <files>src/plugins/interactive-dashboard/components/cards/MapCard.vue</files>
  <action>
Replace remaining hardcoded colors in MapCard.vue:

1. **Loading overlay colors** (~line 1917-1934 in style section):
   - Change `background: rgba(255, 255, 255, 0.9)` to use CSS variable
   - Change spinner colors to use CSS variables

2. **Spinner colors** (~line 1929-1930):
   - `border: 4px solid #e5e7eb` -> `border: 4px solid var(--dashboard-border-default)`
   - `border-top-color: #3b82f6` -> `border-top-color: var(--dashboard-interaction-selected)`

3. **Map controls styling** (~line 1862-1903):
   - `background: var(--bgPanel, #f8f9fa)` is already using var() fallback - update to:
     `background: var(--dashboard-bg-secondary)`
   - Border colors, text colors to use --dashboard-* variables

4. **DEFAULT_CATEGORICAL_COLORS** (~line 1348-1366):
   - Keep these hardcoded for now (they're semantic domain colors, not theme colors)
   - Add comment: `// Domain-specific colors - not theme-dependent`

5. **Baseline layer colors** (createBaselineLayer ~line 779):
   - `[180, 180, 180, 80]` - this is intentionally gray for comparison mode, keep as-is
   - Add comment: `// Comparison baseline - intentionally neutral gray`

6. **Update CSS section** to use dashboard CSS variables:
   ```css
   .map-controls {
     background: var(--dashboard-bg-secondary);
     border-bottom: 1px solid var(--dashboard-border-default);
   }

   .control-label {
     color: var(--dashboard-text-primary);
   }

   .control-select {
     border: 1px solid var(--dashboard-border-default);
     background: var(--dashboard-bg-primary);
     color: var(--dashboard-text-primary);
   }

   .control-select:hover,
   .control-select:focus {
     border-color: var(--dashboard-interaction-selected);
   }
   ```
  </action>
  <verify>
    - Map controls visually match theme (dark controls on dark mode, light on light mode)
    - Loading spinner uses theme colors
    - `grep -c "var(--dashboard-" MapCard.vue` returns 10+
  </verify>
  <done>
    - All UI elements in MapCard use CSS variables
    - Theme switch updates all visible colors
    - No new visual regressions
  </done>
</task>

<task type="auto">
  <name>Task 3: Update ColorLegend component for theme consistency</name>
  <files>src/plugins/interactive-dashboard/components/cards/ColorLegend.vue</files>
  <action>
First, read ColorLegend.vue to understand its current structure, then update:

1. **Check for hardcoded colors** in:
   - Background colors
   - Text colors
   - Border colors
   - Any RGBA arrays

2. **Update CSS to use dashboard variables**:
   ```css
   .color-legend {
     background: var(--dashboard-bg-secondary);
     border: 1px solid var(--dashboard-border-default);
     color: var(--dashboard-text-primary);
   }

   .legend-title {
     color: var(--dashboard-text-primary);
     border-bottom: 1px solid var(--dashboard-border-subtle);
   }

   .legend-item:hover {
     background: var(--dashboard-bg-tertiary);
   }
   ```

3. **Numeric gradient legend** (if present):
   - The gradient colors themselves may be data-driven (viridis etc.) - those are fine
   - But min/max labels should use theme text colors

4. **Click-to-filter styling**:
   - Active/selected legend items should use --dashboard-interaction-selected for border or highlight

5. **Ensure isDarkMode prop is still used** for any cases where CSS variables aren't sufficient
   (e.g., passing colors to Plotly or deck.gl)
  </action>
  <verify>
    - ColorLegend displays correctly in both light and dark mode
    - Text is readable in both modes
    - Hover states work correctly
  </verify>
  <done>
    - ColorLegend uses CSS variables for theme colors
    - Visual consistency with rest of dashboard
    - Legend items remain readable in both themes
  </done>
</task>

<task type="auto">
  <name>Task 4: Implement YAML cluster color configuration</name>
  <files>src/plugins/interactive-dashboard/InteractiveDashboard.vue</files>
  <action>
Add support for configuring OD cluster colors via dashboard YAML. This fulfills THEME-03 requirement.

1. **YAML syntax** (document in code comments):
   ```yaml
   # In dashboard YAML config
   colors:
     clusters:
       origin: "#2563eb"       # Blue for origin clusters
       destination: "#dc2626"  # Red for destination clusters
   ```

2. **Parse colors in InteractiveDashboard mounted()** (after initializeTheme call):
   ```typescript
   import { StyleManager, initializeTheme } from './managers/StyleManager'

   // In mounted():
   initializeTheme()

   // Apply YAML color overrides if present
   if (this.config?.colors?.clusters) {
     const { origin, destination } = this.config.colors.clusters
     StyleManager.getInstance().setClusterColors({ origin, destination })
   }
   ```

3. **Ensure StyleManager.setClusterColors exists** (should be added in Plan 01-01 Task 1):
   - Updates internal cluster colors
   - Re-injects CSS variables with new values
   - MapCard picks up new colors via getClusterColor()

4. **Add TypeScript interface** for config colors:
   ```typescript
   interface DashboardConfig {
     // ... existing fields
     colors?: {
       clusters?: {
         origin?: string
         destination?: string
       }
     }
   }
   ```

5. **Validate color values** (optional but recommended):
   - Check hex format (#RRGGBB or #RGB)
   - Log warning if invalid, use defaults

6. **Document YAML syntax** in code comment at config parsing location:
   ```typescript
   /**
    * Dashboard YAML color configuration:
    *
    * colors:
    *   clusters:
    *     origin: "#2563eb"       # Hex color for origin clusters
    *     destination: "#dc2626"  # Hex color for destination clusters
    *
    * If not specified, colorblind-safe defaults are used.
    */
   ```
  </action>
  <verify>
    - Create test YAML with custom cluster colors
    - Load dashboard with custom colors - verify map shows correct colors
    - Load dashboard without colors config - verify defaults are used
    - Check ColorLegend reflects YAML-configured colors
  </verify>
  <done>
    - Dashboard YAML supports colors.clusters.origin and colors.clusters.destination
    - StyleManager receives YAML overrides at dashboard initialization
    - MapCard and ColorLegend display YAML-configured colors
    - Defaults used when YAML colors not specified
  </done>
</task>

</tasks>

<verification>
1. Run `npm run dev` and load a dashboard with MapCard
2. Toggle theme (dark/light) - map controls, tooltips, legend should all update
3. Hover over map features - consistent orange highlight
4. Click map features - consistent blue selection
5. Check ColorLegend - readable in both themes, click-to-filter works
6. Test YAML configuration:
   - Create test YAML with `colors: { clusters: { origin: "#22c55e", destination: "#a855f7" } }`
   - Load dashboard - verify green origin clusters and purple destination clusters
7. Grep for remaining hardcoded colors: `grep -E "\[59, 130|#3b82f6|#fbbf24" MapCard.vue` should return only comments/false positives
</verification>

<success_criteria>
1. MapCard has no hardcoded interaction state colors (hover/selected)
2. MapCard UI elements use CSS variables (--dashboard-*)
3. ColorLegend uses CSS variables for theme-dependent styling
4. Dashboard YAML can override OD cluster colors
5. Visual appearance is identical before and after migration (no regressions)
6. Theme switching works correctly for all map elements
</success_criteria>

<output>
After completion, create `.planning/phases/01-theming-foundation/01-02-SUMMARY.md`
</output>
