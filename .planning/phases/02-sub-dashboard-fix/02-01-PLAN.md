---
phase: 02-sub-dashboard-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/plugins/interactive-dashboard/components/FullscreenPortal.vue
  - src/plugins/interactive-dashboard/components/cards/SubDashboard.vue
  - src/plugins/interactive-dashboard/InteractiveDashboard.vue
autonomous: true

must_haves:
  truths:
    - "Enlarge button appears on card headers within sub-dashboards"
    - "Clicking enlarge on sub-dashboard card expands to full viewport"
    - "Escape key or close button returns card to original position"
    - "Enlarged card renders above all other content (z-index works)"
  artifacts:
    - path: "src/plugins/interactive-dashboard/components/FullscreenPortal.vue"
      provides: "Portal component for teleporting content to document.body"
      exports: ["default"]
    - path: "src/plugins/interactive-dashboard/components/cards/SubDashboard.vue"
      provides: "Updated sub-dashboard with fullscreen support"
      contains: "FullscreenPortal"
  key_links:
    - from: "SubDashboard.vue"
      to: "FullscreenPortal.vue"
      via: "component import and usage"
      pattern: "import FullscreenPortal|<fullscreen-portal"
    - from: "FullscreenPortal.vue"
      to: "document.body"
      via: "DOM teleportation"
      pattern: "appendChild|insertBefore"
---

<objective>
Implement fullscreen portal pattern for sub-dashboard cards

Purpose: Sub-dashboard cards are trapped by CSS containment (`contain: layout`) which prevents `position: fixed` from working. This plan implements a portal pattern that teleports enlarged content to document.body, bypassing all parent CSS containment.

Output: FullscreenPortal component and updated SubDashboard with working enlarge functionality
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/PITFALLS.md (Pitfall #4: CSS Containment Blocking Card Enlargement)

# Relevant source files
@src/plugins/interactive-dashboard/components/cards/SubDashboard.vue
@src/plugins/interactive-dashboard/components/cards/DataTableCard.vue (existing fullscreen pattern)
@src/plugins/interactive-dashboard/InteractiveDashboard.vue (existing toggleZoom pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FullscreenPortal component</name>
  <files>src/plugins/interactive-dashboard/components/FullscreenPortal.vue</files>
  <action>
Create a Vue 2.7 component that teleports its slot content to document.body when active.

Requirements:
- Props: `active: boolean` (controls whether content is teleported)
- Slot: default slot for content to teleport
- On mount when active: create wrapper div, append to document.body
- On active change to true: move slot content to body wrapper
- On active change to false: move content back to original location
- On unmount: clean up body wrapper, restore content

Implementation approach (Vue 2 compatible - no teleport):
```typescript
// Use manual DOM manipulation since Vue 2 doesn't have <teleport>
// Create a container div on document.body
// Use $el to move content between original parent and body container

export default {
  props: {
    active: { type: Boolean, default: false }
  },
  data() {
    return {
      portalContainer: null as HTMLElement | null,
      originalParent: null as HTMLElement | null
    }
  },
  watch: {
    active(isActive) {
      if (isActive) this.moveToPortal()
      else this.moveBack()
    }
  },
  methods: {
    createPortalContainer() {
      // Create container with fullscreen styles
      // z-index: 10000 (above sub-dashboard's 9999)
      // position: fixed, inset: 0
      // background: var(--dashboard-bg-primary)
    },
    moveToPortal() { ... },
    moveBack() { ... }
  }
}
```

Style the portal container:
- position: fixed, inset: 0
- z-index: 10000 (higher than DataTableCard's 9999)
- background: var(--dashboard-bg-primary, var(--bgBold))
- display: flex for content centering
- Include close button in top-right corner

Handle Escape key:
- Add keydown listener for Escape when active
- Emit 'close' event when Escape pressed
- Remove listener when inactive or unmounted

Use Composition API with defineComponent for Vue 2.7 compatibility.
  </action>
  <verify>
- Component file exists at correct path
- No TypeScript errors: `npx vue-tsc --noEmit 2>&1 | grep -i FullscreenPortal || echo "No errors"`
- Component exports default
  </verify>
  <done>
FullscreenPortal component exists with:
- active prop controlling teleportation
- Slot content moves to document.body when active
- Close button and Escape key support
- Proper cleanup on deactivation/unmount
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate fullscreen into SubDashboard card rendering</name>
  <files>src/plugins/interactive-dashboard/components/cards/SubDashboard.vue</files>
  <action>
Modify SubDashboard.vue to wrap embedded dashboard cards with fullscreen capability.

The challenge: SubDashboard renders an embedded InteractiveDashboard which has its own card rendering. We need to enable fullscreen for cards WITHIN that embedded dashboard.

Approach: Pass a prop to the embedded dashboard indicating it's in a sub-dashboard context, and have InteractiveDashboard use FullscreenPortal for its cards when in that context.

Changes to SubDashboard.vue:
1. Import FullscreenPortal component
2. Add `isSubDashboard: true` prop to embedded-dashboard component

The actual fullscreen handling will be in InteractiveDashboard.vue (Task 3), but SubDashboard needs to signal the context.

Also remove or adjust `contain: layout` CSS rule:
```scss
.sub-dashboard-wrapper {
  // Remove: contain: layout;
  // Keep: position: relative, overflow: hidden
  // The portal pattern handles containment escape
}
```

Or change to `contain: paint` which clips but doesn't affect positioning context.
  </action>
  <verify>
- SubDashboard.vue passes isSubDashboard prop to embedded dashboard
- CSS containment rule is removed or changed to `contain: paint`
- No rendering issues in sub-dashboards
  </verify>
  <done>
SubDashboard.vue:
- Passes isSubDashboard context to embedded dashboard
- CSS containment adjusted to not block fullscreen
  </done>
</task>

<task type="auto">
  <name>Task 3: Update InteractiveDashboard card rendering for portal fullscreen</name>
  <files>src/plugins/interactive-dashboard/InteractiveDashboard.vue</files>
  <action>
Modify InteractiveDashboard.vue to use FullscreenPortal for card fullscreen when rendered inside a sub-dashboard.

Changes:
1. Add new prop: `isSubDashboard: { type: Boolean, default: false }`
2. Import FullscreenPortal component
3. Register FullscreenPortal in components
4. Modify card rendering to wrap with FullscreenPortal when in sub-dashboard context

In the template, wrap card content with FullscreenPortal:
```pug
//- For each card in .dash-card-frame
fullscreen-portal(:active="isSubDashboard && fullScreenCardId === card.id" @close="toggleZoom(card)")
  .dash-card-frame(...)
    //- existing card rendering
```

Key considerations:
- Only use portal when `isSubDashboard` is true (top-level cards use existing pattern)
- When portal is active, card.id matches fullScreenCardId
- Portal emits 'close' which calls toggleZoom to exit fullscreen
- Existing toggleZoom method works as-is

Ensure the card maintains all its props and event handlers when inside portal:
- filteredData, hoveredIds, selectedIds from LinkableCardWrapper
- All the component-specific props (layers, colorBy, etc.)

The existing `getCardStyle(card)` method handles fullscreen styling, but we need to ensure
it works correctly inside the portal. May need to adjust styles when in portal mode.

Add Escape key handler at dashboard level as backup:
```typescript
mounted() {
  if (this.isSubDashboard) {
    window.addEventListener('keydown', this.handleEscapeKey)
  }
}

handleEscapeKey(e: KeyboardEvent) {
  if (e.key === 'Escape' && this.fullScreenCardId) {
    this.fullScreenCardId = ''
  }
}
```
  </action>
  <verify>
- InteractiveDashboard accepts isSubDashboard prop
- FullscreenPortal is imported and registered
- Cards in sub-dashboards can be enlarged to full viewport
- Escape key closes fullscreen
- Run dev server and test manually with a sub-dashboard configuration
  </verify>
  <done>
InteractiveDashboard.vue:
- Accepts isSubDashboard prop
- Uses FullscreenPortal for card fullscreen in sub-dashboard context
- Escape key closes fullscreen
- Cards maintain full interactivity when enlarged
  </done>
</task>

</tasks>

<verification>
1. Build passes: `npm run build` completes without errors
2. Dev server starts: `npm run dev`
3. Open a dashboard with sub-dashboards in browser
4. Verify enlarge button appears on sub-dashboard card headers
5. Click enlarge - card should expand to full viewport
6. Press Escape - card should return to original position
7. Enlarged card should allow hover, select, zoom interactions
</verification>

<success_criteria>
- SUBD-01: Enlarge button visible on sub-dashboard card headers
- SUBD-02: Enlarged card breaks out to full viewport (not clipped by sub-dashboard container)
- Escape key closes fullscreen view
- Card maintains interactivity in fullscreen mode
- Build passes with no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-sub-dashboard-fix/02-01-SUMMARY.md`
</output>
