---
phase: 02-sub-dashboard-fix
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/plugins/interactive-dashboard/components/FullscreenPortal.vue
  - src/plugins/interactive-dashboard/InteractiveDashboard.vue
autonomous: false

must_haves:
  truths:
    - "MapCard in sub-dashboard can be enlarged and maintains map interactivity"
    - "DataTableCard in sub-dashboard can be enlarged and maintains scroll/sort"
    - "HistogramCard in sub-dashboard can be enlarged and maintains hover/filter"
    - "Close button visible in fullscreen mode"
  artifacts:
    - path: "src/plugins/interactive-dashboard/components/FullscreenPortal.vue"
      provides: "Polished portal with visible close button and transitions"
      contains: "fa-compress"
  key_links:
    - from: "MapCard (fullscreen)"
      to: "deck.gl layers"
      via: "WebGL context preserved"
      pattern: "preserveDrawingBuffer"
---

<objective>
Verify and polish fullscreen behavior across all card types

Purpose: Ensure all interactive dashboard card types (MapCard, DataTableCard, HistogramCard, PieChartCard, ScatterCard) work correctly in fullscreen mode from sub-dashboards. Polish the user experience with transitions and clear close affordance.

Output: Verified fullscreen functionality for all card types with polished UX
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-sub-dashboard-fix/02-01-SUMMARY.md

# Relevant source files
@src/plugins/interactive-dashboard/components/FullscreenPortal.vue
@src/plugins/interactive-dashboard/components/cards/MapCard.vue
@src/plugins/interactive-dashboard/components/cards/DataTableCard.vue
@src/plugins/interactive-dashboard/components/cards/HistogramCard.vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add visual close button and transitions to FullscreenPortal</name>
  <files>src/plugins/interactive-dashboard/components/FullscreenPortal.vue</files>
  <action>
Polish the FullscreenPortal component with clear visual affordances:

1. Add a visible close button in the top-right corner:
```vue
<button class="fullscreen-close-btn" @click="$emit('close')" title="Close (Escape)">
  <i class="fa fa-compress"></i>
</button>
```

Style the close button:
```scss
.fullscreen-close-btn {
  position: absolute;
  top: 1rem;
  right: 1rem;
  z-index: 10001;  // Above portal content
  background: var(--dashboard-bg-secondary, rgba(0,0,0,0.5));
  border: 1px solid var(--dashboard-border-default, rgba(255,255,255,0.2));
  border-radius: 4px;
  color: var(--dashboard-text-primary, white);
  padding: 0.5rem 0.75rem;
  cursor: pointer;
  font-size: 1rem;

  &:hover {
    background: var(--dashboard-bg-tertiary, rgba(255,255,255,0.1));
  }
}
```

2. Add fade transition for smooth open/close:
```scss
.fullscreen-portal-container {
  transition: opacity 0.2s ease-in-out;

  &.entering {
    opacity: 0;
  }

  &.entered {
    opacity: 1;
  }
}
```

3. Ensure content area has proper padding to not overlap close button:
```scss
.fullscreen-content {
  position: absolute;
  inset: 0;
  padding: 1rem;
  padding-top: 3.5rem;  // Space for close button
  display: flex;
  flex-direction: column;
}
```
  </action>
  <verify>
- Close button visible in top-right when fullscreen active
- Click on close button triggers close event
- Transition is smooth (not jarring instant appear/disappear)
  </verify>
  <done>
FullscreenPortal has visible close button and smooth transitions
  </done>
</task>

<task type="auto">
  <name>Task 2: Ensure MapCard WebGL context survives portal teleportation</name>
  <files>src/plugins/interactive-dashboard/InteractiveDashboard.vue</files>
  <action>
MapCard uses deck.gl which creates WebGL contexts. When DOM nodes are moved (teleported to body), WebGL contexts can be lost.

Investigation needed:
1. Test if MapCard works when teleported (WebGL context preserved?)
2. If context is lost, implement workaround

Potential solutions if WebGL context is lost:

Option A: Force MapCard to re-render after teleportation
- Emit resize event after portal transition completes
- MapCard should handle resize and re-render

Option B: Don't teleport the WebGL canvas, only the container
- More complex, may not be feasible

Option C: Destroy and recreate deck.gl instance
- Use key prop to force remount when entering/exiting fullscreen
- Add `key` that changes when fullscreen state changes

In InteractiveDashboard.vue, when rendering MapCard in portal context:
```pug
component.dash-card(
  :is="getCardComponent(card)"
  :key="`${card.id}-${isSubDashboard && fullScreenCardId === card.id ? 'fs' : 'normal'}`"
  ...
)
```

This forces Vue to recreate the component when entering/exiting fullscreen,
ensuring fresh deck.gl initialization.

After teleportation, emit resize event to trigger dimension recalculation:
```typescript
// In FullscreenPortal.vue
watch: {
  active(newVal) {
    if (newVal) {
      this.$nextTick(() => {
        window.dispatchEvent(new Event('resize'))
      })
    }
  }
}
```
  </action>
  <verify>
- MapCard renders correctly in fullscreen mode
- Pan and zoom work in fullscreen MapCard
- Hover and select interactions work
- Map doesn't go blank or lose layers after teleportation
  </verify>
  <done>
MapCard WebGL context works correctly in fullscreen mode via portal
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Sub-dashboard fullscreen functionality for all card types:
- FullscreenPortal component with close button and transitions
- InteractiveDashboard integration for sub-dashboard context
- MapCard WebGL context handling
  </what-built>
  <how-to-verify>
1. Start dev server: `npm run dev`
2. Navigate to a dashboard that has sub-dashboards (or create a test config)
3. Expand a sub-dashboard section
4. For each card type in the sub-dashboard:
   - Verify enlarge button (expand icon) is visible in card header
   - Click enlarge button
   - Verify card expands to full viewport (not clipped)
   - Verify close button visible in top-right
   - Test card interactivity (hover, click, zoom for maps)
   - Click close button OR press Escape
   - Verify card returns to original position in sub-dashboard

Test specifically:
- [ ] MapCard: Pan/zoom, hover highlights, layer visibility
- [ ] DataTableCard: Scroll, sort columns, row selection
- [ ] HistogramCard: Hover bars, filter by clicking
- [ ] Any other card types present

Check for:
- [ ] No visual glitches during open/close transition
- [ ] No console errors
- [ ] Z-index correct (fullscreen card above everything)
  </how-to-verify>
  <resume-signal>Type "approved" if all card types work correctly, or describe specific issues found</resume-signal>
</task>

</tasks>

<verification>
1. Build passes: `npm run build`
2. All card types work in sub-dashboard fullscreen mode
3. No console errors during fullscreen transitions
4. User verification of visual quality and interactions
</verification>

<success_criteria>
- All success criteria from 02-01 still pass
- Close button clearly visible and functional
- Smooth transitions (no jarring state changes)
- MapCard maintains full interactivity (pan, zoom, hover, select)
- DataTableCard maintains scroll and sort functionality
- Chart cards maintain hover and filter interactions
- Human verification approves the implementation
</success_criteria>

<output>
After completion, create `.planning/phases/02-sub-dashboard-fix/02-02-SUMMARY.md`
</output>
